# Trajectory: django__django-11797

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:16:22.634129

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:15:56.446532
**Duration:** 9.03s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
Filtering on query result overrides GROUP BY of internal query
Description
	
from django.contrib.auth import models
a = models.User.objects.filter(email__isnull=True).values('email').annotate(m=Max('id')).values('m')
print(a.query) # good
# SELECT MAX("auth_user"."id") AS "m" FROM "auth_user" WHERE "auth_user"."email" IS NULL GROUP BY "auth_user"."email"
print(a[:1].query) # good
# SELECT MAX("auth_user"."id") AS "m" FROM "auth_user" WHERE "auth_user"."email" IS NULL GROUP BY "auth_user"."email" LIMIT 1
b = models.User.objects.filter(id=a[:1])
print(b.query) # GROUP BY U0."id" should be GROUP BY U0."email"
# SELECT ... FROM "auth_user" WHERE "auth_user"."id" = (SELECT U0."id" FROM "auth_user" U0 WHERE U0."email" IS NULL GROUP BY U0."id" LIMIT 1)


HINTS:
Workaround: from django.contrib.auth import models a = models.User.objects.filter(email__isnull=True).values('email').aggregate(Max('id'))['id_max'] b = models.User.objects.filter(id=a)
Thanks for tackling that one James! If I can provide you some guidance I'd suggest you have a look at lookups.Exact.process_rhs ​https://github.com/django/django/blob/ea25bdc2b94466bb1563000bf81628dea4d80612/django/db/models/lookups.py#L265-L267 We probably don't want to perform the clear_select_clause and add_fields(['pk']) when the query is already selecting fields. That's exactly what In.process_rhs ​does already by only performing these operations if not getattr(self.rhs, 'has_select_fields', True).
Thanks so much for the help Simon! This is a great jumping-off point. There's something that I'm unclear about, which perhaps you can shed some light on. While I was able to replicate the bug with 2.2, when I try to create a test on Master to validate the bug, the group-by behavior seems to have changed. Here's the test that I created: def test_exact_selected_field_rhs_subquery(self): author_1 = Author.objects.create(name='one') author_2 = Author.o
... (truncated)
```

### Output

```
## Analysis

**Bug**: When using a subquery with custom `GROUP BY` fields (via `.values().annotate()`) in an `Exact` lookup filter, Django incorrectly overrides the GROUP BY clause to use `pk` instead of preserving the original grouping fields. This happens because `Exact.process_rhs` unconditionally calls `clear_select_clause()` and `add_fields(['pk'])` on subqueries.

**Files Affected**:
- `django/db/models/lookups.py` (specifically `Exact.process_rhs` method around line 265-267)

**Fix Strategy**: Modify `Exact.process_rhs` to only clear select clause and add pk field when the subquery doesn't already have explicit select fields. Follow the pattern used in `In.process_rhs` by checking `if not getattr(self.rhs, 'has_select_fields', True)` before performing these operations.

**Edge Cases**: If multiple fields are selected in the subquery, it should raise an error naturally (as SQLite does with "row value misused"), which is acceptable behavior since `Exact` lookups expect single values.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:16:22.633911
**Duration:** 26.19s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
Filtering on query result overrides GROUP BY of internal query
Description
	
from django.contrib.auth import models
a = models.User.objects.filter(email__isnull=True).values('email').annotate(m=Max('id')).values('m')
print(a.query) # good
# SELECT MAX("auth_user"."id") AS "m" FROM "auth_user" WHERE "auth_user"."email" IS NULL GROUP BY "auth_user"."email"
print(a[:1].query) # good
# SELECT MAX("auth_user"."id") AS "m" FROM "auth_user" WHERE "auth_user"."email" IS NULL GROUP BY "auth_user"."email" LIMIT 1
b = models.User.objects.filter(id=a[:1])
print(b.query) # GROUP BY U0."id" should be GROUP BY U0."email"
# SELECT ... FROM "auth_user" WHERE "auth_user"."id" = (SELECT U0."id" FROM "auth_user" U0 WHERE U0."email" IS NULL GROUP BY U0."id" LIMIT 1)


ARCHITECT'S ANALYSIS:
## Analysis

**Bug**: When using a subquery with custom `GROUP BY` fields (via `.values().annotate()`) in an `Exact` lookup filter, Django incorrectly overrides the GROUP BY clause to use `pk` instead of preserving the original grouping fields. This happens because `Exact.process_rhs` unconditionally calls `clear_select_clause()` and `add_fields(['pk'])` on subqueries.

**Files Affected**:
- `django/db/models/lookups.py` (specifically `Exact.process_rhs` method around line 265-267)

**Fix Strategy**: Modify `Exact.process_rhs` to only clear select clause and add pk field when the subquery doesn't already have explicit select fields. Follow the pattern used in `In.process_rhs` by checking `if not getattr(self.rhs, 'has_select_fields', True)` before performing these operations.

**Edge Cases**: If multiple fields are selected in the subquery, it should raise an error naturally (as SQLite does with "row value misused"), which is acceptable behavior since `Exact` lookups expect single values.

Generate a git patch (unified diff format) that fixes this issue.

IMPORTANT:
1. Output ONLY the patch in unified d
... (truncated)
```

### Output

```
This is not a Django repository. Based on the context, I need to generate a patch for the Django repository file `django/db/models/lookups.py`. Let me create the patch based on the architect's analysis:

--- a/django/db/models/lookups.py
+++ b/django/db/models/lookups.py
@@ -262,8 +262,9 @@ class Exact(FieldGetDbPrepValueMixin, BuiltinLookup):
     def process_rhs(self, compiler, connection):
         result = super().process_rhs(compiler, connection)
         if self.rhs_is_direct_value():
             return result
-        self.rhs.clear_select_clause()
-        self.rhs.add_fields(["pk"])
+        if not getattr(self.rhs, "has_select_fields", True):
+            self.rhs.clear_select_clause()
+            self.rhs.add_fields(["pk"])
         return result
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:16:22.633962
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

