# Trajectory: django__django-14855

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:01:36.435046

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:00:37.679415
**Duration:** 8.91s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


HINTS:
Hey Ken, yes seems right. Good spot. Looks like this should have been part of b79088306513d5ed76d31ac40ab3c15f858946ea for #31181 (which was Django 3.2) â€‹here. However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track. I ran your suggestion against most of the usual suspects admin_* tests without issue so... Would you like to prepare a patch? Looks like setting up the test case is the most of it... Thanks!
I'll be happy to try - but I'm not likely to be able to get to it before the weekend. (I don't know how "urgent" you consider it.) If it can sit that long, I'll see what I can do. (First "real patch" and all that - want to make sure I do it reasonably right.)
Hey Ken. Super thanks! Since it's a bug in a new feature it's marked as release blocker and will be backported to
... (truncated)
```

### Output

```
## Analysis

**Bug**: In custom Admin Sites, `get_admin_url()` generates URLs with `/admin/` prefix instead of the custom site's prefix (e.g., `/custom-admin/`) for readonly ForeignKey fields. This happens because the `reverse()` call doesn't pass `current_app` parameter to identify the correct admin site instance.

**Files affected**:
- `django/contrib/admin/helpers.py` - The `get_admin_url()` method needs to be fixed
- Tests in `tests/admin_*/` - Need new test case for custom admin site with readonly ForeignKey

**Fix strategy**: Add `current_app=self.model_admin.admin_site.name` parameter to the `reverse()` call in `get_admin_url()`, mirroring the pattern used elsewhere in admin (e.g., `response_add()`). This was missed in the original implementation for #31181.

**Edge cases**: Ensure behavior is correct for default admin site (where `current_app` should work transparently), nested admin sites, and cases where `model_admin` or `admin_site` might be None.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:01:36.434691
**Duration:** 58.76s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.


ARCHITECT'S ANALYSIS:
## Analysis

**Bug**: In custom Admin Sites, `get_admin_url()` generates URLs with `/admin/` prefix instead of the custom site's prefix (e.g., `/custom-admin/`) for readonly ForeignKey fields. This happens because the `reverse()` call doesn't pass `current_app` parameter to identify the correct admin site instance.

**Files affected**:
- `django/contrib/admin/helpers.py` - The `get_admin_url()` method needs to be fixed
- Tests in `tests/admin_*/` - Need new test case for custom admin site with readonly ForeignKey

**Fix strategy**: Add `current_app=self.model_admin.admin_site.name` parameter to the `reverse()` call in `get_admin_url()`, mirroring the pattern used elsewhere in admin (e.g., `response_add()`). This was missed in the original implementation for #31181.

**Edge cases**: Ensure behavior is correct for default admin site (where `current_app` s
... (truncated)
```

### Output

```
Perfect! I can see this is the exact issue I need to fix. The patch has already been generated in a previous run and matches exactly what the issue description asks for. However, the user wants me to generate it in raw unified diff format without markdown code blocks. Let me generate the proper patch:

--- a/django/contrib/admin/helpers.py
+++ b/django/contrib/admin/helpers.py
@@ -209,7 +209,11 @@ class AdminReadonlyField:
                     remote_obj = getattr(self.obj, name)
                     if remote_obj is not None:
                         url_name = f'admin:{model._meta.app_label}_{model._meta.model_name}_change'
-                        url = reverse(url_name, args=[quote(remote_obj.pk)])
+                        url = reverse(
+                            url_name,
+                            args=[quote(remote_obj.pk)],
+                            current_app=self.model_admin.admin_site.name,
+                        )
                         return format_html('<a href="{}">{}</a>', url, remote_obj)
         except NoReverseMatch:
             pass
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:01:36.434753
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

