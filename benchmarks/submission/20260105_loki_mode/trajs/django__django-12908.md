# Trajectory: django__django-12908

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:33:00.720722

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:32:37.328551
**Duration:** 10.09s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
Union queryset should raise on distinct().
Description
	 
		(last modified by Sielc Technologies)
	 
After using
.annotate() on 2 different querysets
and then .union()
.distinct() will not affect the queryset
	def setUp(self) -> None:
		user = self.get_or_create_admin_user()
		Sample.h.create(user, name="Sam1")
		Sample.h.create(user, name="Sam2 acid")
		Sample.h.create(user, name="Sam3")
		Sample.h.create(user, name="Sam4 acid")
		Sample.h.create(user, name="Dub")
		Sample.h.create(user, name="Dub")
		Sample.h.create(user, name="Dub")
		self.user = user
	def test_union_annotated_diff_distinct(self):
		qs = Sample.objects.filter(user=self.user)
		qs1 = qs.filter(name='Dub').annotate(rank=Value(0, IntegerField()))
		qs2 = qs.filter(name='Sam1').annotate(rank=Value(1, IntegerField()))
		qs = qs1.union(qs2)
		qs = qs.order_by('name').distinct('name') # THIS DISTINCT DOESN'T WORK
		self.assertEqual(qs.count(), 2)
expected to get wrapped union
	SELECT DISTINCT ON (siebox_sample.name) * FROM (SELECT ... UNION SELECT ...) AS siebox_sample


HINTS:
distinct() is not supported but doesn't raise an error yet. As ​​per the documentation, "only LIMIT, OFFSET, COUNT(*), ORDER BY, and specifying columns (i.e. slicing, count(), order_by(), and values()/values_list()) are allowed on the resulting QuerySet.". Follow up to #27995.

Your job:
1. Understand what the issue is about
2. Identify which file(s) likely need to be changed
3. Describe the fix approach (2-3 sentences)
4. Note any edge cases

Output a brief analysis (5-7 lines max) with:
- What the bug/issue is
- Files likely affected
- Fix strategy

Keep it concise - the Engineer agent will generate the patch.
```

### Output

```
## Analysis

**Issue**: Union querysets silently ignore `.distinct()` calls instead of raising an error. The documentation states that `distinct()` is not supported on union querysets, but currently it fails silently rather than raising a `NotSupportedError`.

**Files likely affected**:
- `django/db/models/query.py` - The `QuerySet.distinct()` method needs to check if the queryset is a union and raise an error
- Possibly `tests/queries/tests.py` or similar test file to add test coverage

**Fix strategy**: In the `QuerySet.distinct()` method, add a check similar to other unsupported operations on union querysets (like `select_related()`, etc.) that raises `NotSupportedError` when `self.query.combinator` is set. This follows the pattern established in issue #27995 for other unsupported operations.

**Edge cases**: Ensure the error is raised before any query execution, and verify that the error message clearly indicates that `distinct()` is not supported on union/intersection/difference querysets.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:33:00.720561
**Duration:** 23.39s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
Union queryset should raise on distinct().
Description
	 
		(last modified by Sielc Technologies)
	 
After using
.annotate() on 2 different querysets
and then .union()
.distinct() will not affect the queryset
	def setUp(self) -> None:
		user = self.get_or_create_admin_user()
		Sample.h.create(user, name="Sam1")
		Sample.h.create(user, name="Sam2 acid")
		Sample.h.create(user, name="Sam3")
		Sample.h.create(user, name="Sam4 acid")
		Sample.h.create(user, name="Dub")
		Sample.h.create(user, name="Dub")
		Sample.h.create(user, name="Dub")
		self.user = user
	def test_union_annotated_diff_distinct(self):
		qs = Sample.objects.filter(user=self.user)
		qs1 = qs.filter(name='Dub').annotate(rank=Value(0, IntegerField()))
		qs2 = qs.filter(name='Sam1').annotate(rank=Value(1, IntegerField()))
		qs = qs1.union(qs2)
		qs = qs.order_by('name').distinct('name') # THIS DISTINCT DOESN'T WORK
		self.assertEqual(qs.count(), 2)
expected to get wrapped union
	SELECT DISTINCT ON (siebox_sample.name) * FROM (SELECT ... UNION SELECT ...) AS siebox_sample


ARCHITECT'S ANALYSIS:
## Analysis

**Issue**: Union querysets silently ignore `.distinct()` calls instead of raising an error. The documentation states that `distinct()` is not supported on union querysets, but currently it fails silently rather than raising a `NotSupportedError`.

**Files likely affected**:
- `django/db/models/query.py` - The `QuerySet.distinct()` method needs to check if the queryset is a union and raise an error
- Possibly `tests/queries/tests.py` or similar test file to add test coverage

**Fix strategy**: In the `QuerySet.distinct()` method, add a check similar to other unsupported operations on union querysets (like `select_related()`, etc.) that raises `NotSupportedError` when `self.query.combinator` is set. This follows the pattern established in issue #27995 for other unsupported operations.

**Edge cases**: Ensu
... (truncated)
```

### Output

```
Based on the architect's analysis and my knowledge of Django's codebase structure, I'll generate the patch. The issue states that `distinct()` should raise `NotSupportedError` on union querysets, following the pattern of other unsupported operations.

--- a/django/db/models/query.py
+++ b/django/db/models/query.py
@@ -1410,6 +1410,11 @@
         Return a new QuerySet instance that will select only distinct results.
         """
         self._not_support_combined_queries("distinct")
+        if self.query.combinator:
+            raise NotSupportedError(
+                "Calling distinct() after %s() is not supported."
+                % self.query.combinator
+            )
         assert not self.query.is_sliced, \
             "Cannot create distinct fields once a slice has been taken."
         obj = self._chain()
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:33:00.720595
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

