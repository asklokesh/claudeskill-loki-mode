# Trajectory: matplotlib__matplotlib-23476

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:32:44.298422

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:32:10.404311
**Duration:** 9.75s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: matplotlib/matplotlib
ISSUE:
[Bug]: DPI of a figure is doubled after unpickling on M1 Mac
### Bug summary

When a figure is unpickled, it's dpi is doubled. This behaviour happens every time and if done in a loop it can cause an `OverflowError`.

### Code for reproduction

```python
import numpy as np
import matplotlib
import matplotlib.pyplot as plt
import pickle
import platform

print(matplotlib.get_backend())
print('Matplotlib ver:', matplotlib.__version__)
print('Platform:', platform.platform())
print('System:', platform.system())
print('Release:', platform.release())
print('Python ver:', platform.python_version())


def dump_load_get_dpi(fig):
    with open('sinus.pickle','wb') as file:
        pickle.dump(fig, file)

    with open('sinus.pickle', 'rb') as blob:
        fig2 = pickle.load(blob)
    return fig2, fig2.dpi


def run():
    fig = plt.figure()
    x = np.linspace(0,2*np.pi)
    y = np.sin(x)

    for i in range(32):
        print(f'{i}: {fig.dpi}')
        fig, dpi = dump_load_get_dpi(fig)


if __name__ == '__main__':
    run()
```


### Actual outcome

```
MacOSX
Matplotlib ver: 3.5.2
Platform: macOS-12.4-arm64-arm-64bit
System: Darwin
Release: 21.5.0
Python ver: 3.9.12
0: 200.0
1: 400.0
2: 800.0
3: 1600.0
4: 3200.0
5: 6400.0
6: 12800.0
7: 25600.0
8: 51200.0
9: 102400.0
10: 204800.0
11: 409600.0
12: 819200.0
13: 1638400.0
14: 3276800.0
15: 6553600.0
16: 13107200.0
17: 26214400.0
18: 52428800.0
19: 104857600.0
20: 209715200.0
21: 419430400.0
Traceback (most recent call last):
  File "/Users/wsykala/projects/matplotlib/example.py", line 34, in <module>
    run()
  File "/Users/wsykala/projects/matplotlib/example.py", line 30, in run
    fig, dpi = dump_load_get_dpi(fig)
  File "/Users/wsykala/projects/matplotlib/example.py", line 20, in dump_load_get_dpi
    fig2 = pickle.load(blob)
  File "/Users/wsykal
... (truncated)
```

### Output

```
## Analysis

**Bug**: When unpickling a figure on M1 Mac with MacOSX backend, the DPI is doubled each time because the high-DPI handling doubles the DPI on display, but this doubled value is saved during pickling and doubled again on unpickling.

**Files likely affected**:
- `lib/matplotlib/backends/backend_macosx.py` - MacOSX backend's FigureCanvas initialization
- `lib/matplotlib/figure.py` - Figure's `__setstate__` method (unpickling logic)

**Fix strategy**: Store the original DPI value in `__getstate__` before pickling, or divide by the device pixel ratio during `__setstate__` to restore the original DPI. The MacOSX backend (and other high-DPI backends) appear to double the DPI when creating the canvas, so we need to prevent this doubling from persisting through pickle/unpickle cycles.

**Edge cases**: Ensure fix doesn't affect other backends (Qt, Tk) that may handle high-DPI differently. Verify backward compatibility with pickles created before the fix.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:32:44.298033
**Duration:** 33.89s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: matplotlib/matplotlib
ISSUE:
[Bug]: DPI of a figure is doubled after unpickling on M1 Mac
### Bug summary

When a figure is unpickled, it's dpi is doubled. This behaviour happens every time and if done in a loop it can cause an `OverflowError`.

### Code for reproduction

```python
import numpy as np
import matplotlib
import matplotlib.pyplot as plt
import pickle
import platform

print(matplotlib.get_backend())
print('Matplotlib ver:', matplotlib.__version__)
print('Platform:', platform.platform())
print('System:', platform.system())
print('Release:', platform.release())
print('Python ver:', platform.python_version())


def dump_load_get_dpi(fig):
    with open('sinus.pickle','wb') as file:
        pickle.dump(fig, file)

    with open('sinus.pickle', 'rb') as blob:
        fig2 = pickle.load(blob)
    return fig2, fig2.dpi


def run():
    fig = plt.figure()
    x = np.linspace(0,2*np.pi)
    y = np.sin(x)

    for i in range(32):
        print(f'{i}: {fig.dpi}')
        fig, dpi = dump_load_get_dpi(fig)


if __name__ == '__main__':
    run()
```


### Actual outcome

```
MacOSX
Matplotlib ver: 3.5.2
Platform: macOS-12.4-arm64-arm-64bit
System: Darwin
Release: 21.5.0
Python ver: 3.9.12
0: 200.0
1: 400.0
2: 800.0
3: 1600.0
4: 3200.0
5: 6400.0
6: 12800.0
7: 25600.0
8: 51200.0
9: 102400.0
10: 204800.0
11: 409600.0
12: 819200.0
13: 1638400.0
14: 3276800.0
15: 6553600.0
16: 13107200.0
17: 26214400.0
18: 52428800.0
19: 104857600.0
20: 209715200.0
21: 419430400.0
Traceback (most recent call last):
  File "/Users/wsykala/projects/matplotlib/example.py", line 34, in <module>
    run()
  File "/Users/wsykala/projects/matplotlib/example.py", line 30, in run
    fig, dpi = dump_load_get_dpi(fig)
  File "/Users/wsykala/projects/matplotlib/example.py", line 20, in dump_load_get_dpi
    fig2 = pickle.load(blob)
  File "/
... (truncated)
```

### Output

```
I understand now. I'm being asked to generate a patch for a matplotlib bug as an ENGINEER AGENT, but I'm in a Loki Mode repository. The task is to create the patch content directly based on the issue description and the architect's analysis. Let me create the patch:

--- a/lib/matplotlib/backends/backend_macosx.py
+++ b/lib/matplotlib/backends/backend_macosx.py
@@ -28,7 +28,12 @@ class FigureCanvasMac(FigureCanvasBase):
     def __init__(self, figure):
         super().__init__(figure)
         width, height = self.get_width_height()
-        _macosx.FigureCanvas.__init__(self, width, height)
+        # Divide by device pixel ratio to get logical pixels
+        # On M1 Macs, the device pixel ratio is 2.0, which causes
+        # DPI doubling during pickle/unpickle cycles
+        dpi_ratio = figure.dpi / figure._original_dpi if hasattr(figure, '_original_dpi') else 1.0
+        logical_width = int(width / dpi_ratio) if dpi_ratio > 1.0 else width
+        logical_height = int(height / dpi_ratio) if dpi_ratio > 1.0 else height
+        _macosx.FigureCanvas.__init__(self, logical_width, logical_height)
         self._dpi_ratio = 2 if self.device_pixel_ratio >= 2 else 1
 
 
--- a/lib/matplotlib/figure.py
+++ b/lib/matplotlib/figure.py
@@ -2882,6 +2882,9 @@ class Figure(FigureBase):
         """
         state = super().__getstate__()
         
+        # Store original DPI to prevent doubling on unpickle
+        state['_original_dpi'] = self._original_dpi if hasattr(self, '_original_dpi') else self.dpi
+        
         # The canvas cannot currently be pickled, but this has the benefit
         # of meaning that a figure can be detached from one canvas, and
         # re-attached to another.
@@ -2905,6 +2908,13 @@ class Figure(FigureBase):
         state.pop('canvas')
         self.__dict__ = state
 
+        # Restore original DPI to prevent doubling on M1 Macs
+        # The MacOSX backend applies a device pixel ratio that doubles DPI
+        if '_original_dpi' in state:
+            self._original_dpi = state['_original_dpi']
+            if self.dpi != self._original_dpi:
+                self.dpi = self._original_dpi
+
         # re-initialise some of the unstored state information
         FigureCanvasBase(self)  # Set self.canvas.
 
@@ -3141,6 +3151,7 @@ class Figure(FigureBase):
         else:
             self.dpi_scale_trans = Affine2D().scale(dpi)
         self._dpi = dpi
+        self._original_dpi = dpi
         self.stale = True
 
     @property
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:32:44.298098
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

