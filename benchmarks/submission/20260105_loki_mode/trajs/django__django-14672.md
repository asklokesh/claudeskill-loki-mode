# Trajectory: django__django-14672

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:58:28.877355

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:58:06.585899
**Duration:** 10.09s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
Missing call `make_hashable` on `through_fields` in `ManyToManyRel`
Description
	
In 3.2 identity property has been added to all ForeignObjectRel to make it possible to compare them. A hash is derived from said identity and it's possible because identity is a tuple. To make limit_choices_to hashable (one of this tuple elements), ​there's a call to make_hashable.
It happens that through_fields can be a list. In such case, this make_hashable call is missing in ​ManyToManyRel.
For some reason it only fails on checking proxy model. I think proxy models have 29 checks and normal ones 24, hence the issue, but that's just a guess.
Minimal repro:
class Parent(models.Model):
	name = models.CharField(max_length=256)
class ProxyParent(Parent):
	class Meta:
		proxy = True
class Child(models.Model):
	parent = models.ForeignKey(Parent, on_delete=models.CASCADE)
	many_to_many_field = models.ManyToManyField(
		to=Parent,
		through="ManyToManyModel",
		through_fields=['child', 'parent'],
		related_name="something"
	)
class ManyToManyModel(models.Model):
	parent = models.ForeignKey(Parent, on_delete=models.CASCADE, related_name='+')
	child = models.ForeignKey(Child, on_delete=models.CASCADE, related_name='+')
	second_child = models.ForeignKey(Child, on_delete=models.CASCADE, null=True, default=None)
Which will result in 
 File "manage.py", line 23, in <module>
	main()
 File "manage.py", line 19, in main
	execute_from_command_line(sys.argv)
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/site-packages/django/core/management/__init__.py", line 419, in execute_from_command_line
	utility.execute()
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/site-packages/django/core/management/__init__.py", line 413, in execute
	self.fetch_command(subcommand).run_from_argv(self.argv)
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/site-packages/d
... (truncated)
```

### Output

```
## Analysis

**Bug**: The `ManyToManyRel.identity` property includes `through_fields` which can be a list. When hashing the identity tuple, this causes a `TypeError: unhashable type: 'list'` because lists cannot be hashed. This surfaces when proxy models trigger field name clash checks.

**Files affected**: 
- `django/db/models/fields/reverse_related.py` - The `ManyToManyRel` class needs its `identity` property updated

**Fix strategy**: 
Add a `make_hashable()` call to convert `self.through_fields` (which can be a list) into a hashable type (tuple) within the `ManyToManyRel.identity` property, similar to how `limit_choices_to` is already handled in other relation classes.

**Edge cases**: 
- `through_fields` may be `None` (should remain `None`)
- `through_fields` may already be a tuple (should still work with `make_hashable`)
- Verify other relation classes don't have similar issues with list-type fields
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:58:28.876937
**Duration:** 22.29s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
Missing call `make_hashable` on `through_fields` in `ManyToManyRel`
Description
	
In 3.2 identity property has been added to all ForeignObjectRel to make it possible to compare them. A hash is derived from said identity and it's possible because identity is a tuple. To make limit_choices_to hashable (one of this tuple elements), ​there's a call to make_hashable.
It happens that through_fields can be a list. In such case, this make_hashable call is missing in ​ManyToManyRel.
For some reason it only fails on checking proxy model. I think proxy models have 29 checks and normal ones 24, hence the issue, but that's just a guess.
Minimal repro:
class Parent(models.Model):
	name = models.CharField(max_length=256)
class ProxyParent(Parent):
	class Meta:
		proxy = True
class Child(models.Model):
	parent = models.ForeignKey(Parent, on_delete=models.CASCADE)
	many_to_many_field = models.ManyToManyField(
		to=Parent,
		through="ManyToManyModel",
		through_fields=['child', 'parent'],
		related_name="something"
	)
class ManyToManyModel(models.Model):
	parent = models.ForeignKey(Parent, on_delete=models.CASCADE, related_name='+')
	child = models.ForeignKey(Child, on_delete=models.CASCADE, related_name='+')
	second_child = models.ForeignKey(Child, on_delete=models.CASCADE, null=True, default=None)
Which will result in 
 File "manage.py", line 23, in <module>
	main()
 File "manage.py", line 19, in main
	execute_from_command_line(sys.argv)
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/site-packages/django/core/management/__init__.py", line 419, in execute_from_command_line
	utility.execute()
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/site-packages/django/core/management/__init__.py", line 413, in execute
	self.fetch_command(subcommand).run_from_argv(self.argv)
 File "/home/tom/PycharmProjects/broken_m2m_project/venv/lib/python3.8/sit
... (truncated)
```

### Output

```
I need to understand the context better. This is the Loki Mode skill repository, and I'm being asked to generate a patch for a Django issue. Based on the architect's analysis, I need to create a patch that adds `make_hashable()` to the `through_fields` in the `ManyToManyRel.identity` property.

Let me generate the patch based on the Django source code structure and the issue description:

--- a/django/db/models/fields/reverse_related.py
+++ b/django/db/models/fields/reverse_related.py
@@ -7,7 +7,7 @@ from django.db.models import Q
 from django.utils.functional import cached_property
 from django.utils.hashable import make_hashable
 
-from . import Field
+from . import Field
 
 
 class ForeignObjectRel:
@@ -313,7 +313,7 @@ class ManyToManyRel(ForeignObjectRel):
             self.related_model,
             self.related_query_name(),
             make_hashable(self.limit_choices_to),
-            self.through_fields,
+            make_hashable(self.through_fields),
             self.symmetrical,
             self.db_constraint,
         )
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:58:28.877005
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

