# Trajectory: astropy__astropy-14995

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:03:27.704985

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:03:09.781443
**Duration:** 12.24s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: astropy/astropy
ISSUE:
In v5.3, NDDataRef mask propagation fails when one of the operand does not have a mask
### Description

This applies to v5.3. 

It looks like when one of the operand does not have a mask, the mask propagation when doing arithmetic, in particular with `handle_mask=np.bitwise_or` fails.  This is not a problem in v5.2.

I don't know enough about how all that works, but it seems from the error that the operand without a mask is set as a mask of None's and then the bitwise_or tries to operate on an integer and a None and fails.

### Expected behavior

When one of the operand does not have mask, the mask that exists should just be copied over to the output.  Or whatever was done in that situation in v5.2 where there's no problem.

### How to Reproduce

This is with v5.3.   With v5.2, there are no errors.

```
>>> import numpy as np
>>> from astropy.nddata import NDDataRef

>>> array = np.array([[0, 1, 0], [1, 0, 1], [0, 1, 0]])
>>> mask = np.array([[0, 1, 64], [8, 0, 1], [2, 1, 0]])

>>> nref_nomask = NDDataRef(array)
>>> nref_mask = NDDataRef(array, mask=mask)

# multiply no mask by constant (no mask * no mask)
>>> nref_nomask.multiply(1., handle_mask=np.bitwise_or).mask   # returns nothing, no mask,  OK

# multiply no mask by itself (no mask * no mask)
>>> nref_nomask.multiply(nref_nomask, handle_mask=np.bitwise_or).mask # return nothing, no mask, OK

# multiply mask by constant (mask * no mask)
>>> nref_mask.multiply(1., handle_mask=np.bitwise_or).mask
...
TypeError: unsupported operand type(s) for |: 'int' and 'NoneType'

# multiply mask by itself (mask * mask)
>>> nref_mask.multiply(nref_mask, handle_mask=np.bitwise_or).mask
array([[ 0,  1, 64],
       [ 8,  0,  1],
       [ 2,  1,  0]])

# multiply mask by no mask (mask * no mask)
>>> nref_mask.multiply(nref_nomask, handle_mask=np.bitwise_or).mask
...
TypeError: unsupported operand type(s) fo
... (truncated)
```

### Output

```
## Analysis

**The Bug:**
In astropy v5.3, mask propagation fails when performing arithmetic operations (e.g., multiply) on NDDataRef objects where one operand has a mask and the other doesn't. The issue causes `TypeError: unsupported operand type(s) for |: 'int' and 'NoneType'` when using `handle_mask=np.bitwise_or`. This breaks commutativity of operations and creates unwanted `None` values in boolean masks.

**Root Cause:**
A line was accidentally changed from `elif operand.mask is None:` to `elif operand is None:` in commit feeb716, causing the code to check if the operand itself is None rather than checking if its mask attribute is None. This breaks the logic that should copy the existing mask when the other operand has no mask.

**Files Affected:**
- `astropy/nddata/mixins/ndarithmetic.py` (around line 458-498 based on the commit reference)

**Fix Strategy:**
Revert the condition from `elif operand is None:` back to `elif operand.mask is None:` to restore the v5.2 behavior where if one operand lacks a mask, the other operand's mask is simply copied to the output instead of being passed to the handle_mask function.

**Edge Cases:**
- Both operands without masks (should work, already tested)
- Both operands with masks (should work, already tested)  
- Commutative operations with mixed mask/no-mask operands (currently broken, needs test)
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:03:27.704780
**Duration:** 17.92s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: astropy/astropy
ISSUE:
In v5.3, NDDataRef mask propagation fails when one of the operand does not have a mask
### Description

This applies to v5.3. 

It looks like when one of the operand does not have a mask, the mask propagation when doing arithmetic, in particular with `handle_mask=np.bitwise_or` fails.  This is not a problem in v5.2.

I don't know enough about how all that works, but it seems from the error that the operand without a mask is set as a mask of None's and then the bitwise_or tries to operate on an integer and a None and fails.

### Expected behavior

When one of the operand does not have mask, the mask that exists should just be copied over to the output.  Or whatever was done in that situation in v5.2 where there's no problem.

### How to Reproduce

This is with v5.3.   With v5.2, there are no errors.

```
>>> import numpy as np
>>> from astropy.nddata import NDDataRef

>>> array = np.array([[0, 1, 0], [1, 0, 1], [0, 1, 0]])
>>> mask = np.array([[0, 1, 64], [8, 0, 1], [2, 1, 0]])

>>> nref_nomask = NDDataRef(array)
>>> nref_mask = NDDataRef(array, mask=mask)

# multiply no mask by constant (no mask * no mask)
>>> nref_nomask.multiply(1., handle_mask=np.bitwise_or).mask   # returns nothing, no mask,  OK

# multiply no mask by itself (no mask * no mask)
>>> nref_nomask.multiply(nref_nomask, handle_mask=np.bitwise_or).mask # return nothing, no mask, OK

# multiply mask by constant (mask * no mask)
>>> nref_mask.multiply(1., handle_mask=np.bitwise_or).mask
...
TypeError: unsupported operand type(s) for |: 'int' and 'NoneType'

# multiply mask by itself (mask * mask)
>>> nref_mask.multiply(nref_mask, handle_mask=np.bitwise_or).mask
array([[ 0,  1, 64],
       [ 8,  0,  1],
       [ 2,  1,  0]])

# multiply mask by no mask (mask * no mask)
>>> nref_mask.multiply(nref_nomask, handle_mask=np.bitwise_or).mask
...
TypeError: unsupported operan
... (truncated)
```

### Output

```
This appears to be the claudeskill-loki-mode repository, not the astropy repository. I need to create a patch for the astropy/astropy repository based on the architect's analysis. Let me generate the patch based on the information provided.

According to the architect's analysis, the bug is in `astropy/nddata/mixins/ndarithmetic.py` where a line was changed from `elif operand.mask is None:` to `elif operand is None:`. I need to generate a patch that fixes this.

--- a/astropy/nddata/mixins/ndarithmetic.py
+++ b/astropy/nddata/mixins/ndarithmetic.py
@@ -495,7 +495,7 @@
             # Now let's see if the operand was a scalar, if so the mask is None
             if self.mask is None:
                 result_mask = deepcopy(operand.mask)
-            elif operand is None:
+            elif operand.mask is None:
                 result_mask = deepcopy(self.mask)
             else:
                 result_mask = handle_mask(deepcopy(self.mask), deepcopy(operand.mask))
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:03:27.704817
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

