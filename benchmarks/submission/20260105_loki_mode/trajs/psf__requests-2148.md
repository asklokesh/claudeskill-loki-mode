# Trajectory: psf__requests-2148

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:56:27.585780

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:55:39.721699
**Duration:** 9.24s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: psf/requests
ISSUE:
socket.error exception not caught/wrapped in a requests exception (ConnectionError perhaps?)
I just noticed a case where I had a socket reset on me, and was raised to me as a raw socket error as opposed to something like a requests.exceptions.ConnectionError:

```
  File "/home/rtdean/***/***/***/***/***/***.py", line 67, in dir_parse
    root = ElementTree.fromstring(response.text)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 721, in text
    if not self.content:
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 694, in content
    self._content = bytes().join(self.iter_content(CONTENT_CHUNK_SIZE)) or bytes()
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 627, in generate
    for chunk in self.raw.stream(chunk_size, decode_content=True):
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/packages/urllib3/response.py", line 240, in stream
    data = self.read(amt=amt, decode_content=decode_content)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/packages/urllib3/response.py", line 187, in read
    data = self._fp.read(amt)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 543, in read
    return self._read_chunked(amt)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 612, in _read_chunked
    value.append(self._safe_read(chunk_left))
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 658, in _safe_read
    chunk = self.fp.read(min(amt, MAXAMOUNT))
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/socket.py", line 380, in read
    data = self._sock.recv(left)
  File "/home
... (truncated)
```

### Output

```
Based on the issue and stack trace, here's my analysis:

**Bug**: Socket errors (like connection resets) during response body iteration are not being caught and wrapped in requests exceptions. The raw `socket.error` bubbles up instead of being converted to `requests.exceptions.ConnectionError`.

**Files Affected**:
- `requests/models.py` - specifically the `iter_content()` and `generate()` methods in the Response class (around lines 627-694 based on stack trace)
- Possibly `requests/exceptions.py` - to verify ConnectionError is the appropriate exception type

**Fix Strategy**: Wrap the iteration logic in `Response.iter_content()` or `Response.generate()` with a try/except block that catches `socket.error` (and related low-level exceptions) and re-raises them as `requests.exceptions.ConnectionError`. This maintains consistency with requests' exception hierarchy.

**Edge Cases**: Need to handle both Python 2 (`socket.error`) and Python 3 (`OSError`) socket exceptions. Should preserve original exception context/traceback for debugging.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:56:27.585517
**Duration:** 47.86s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: psf/requests
ISSUE:
socket.error exception not caught/wrapped in a requests exception (ConnectionError perhaps?)
I just noticed a case where I had a socket reset on me, and was raised to me as a raw socket error as opposed to something like a requests.exceptions.ConnectionError:

```
  File "/home/rtdean/***/***/***/***/***/***.py", line 67, in dir_parse
    root = ElementTree.fromstring(response.text)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 721, in text
    if not self.content:
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 694, in content
    self._content = bytes().join(self.iter_content(CONTENT_CHUNK_SIZE)) or bytes()
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/models.py", line 627, in generate
    for chunk in self.raw.stream(chunk_size, decode_content=True):
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/packages/urllib3/response.py", line 240, in stream
    data = self.read(amt=amt, decode_content=decode_content)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/site-packages/requests-2.3.0-py2.7.egg/requests/packages/urllib3/response.py", line 187, in read
    data = self._fp.read(amt)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 543, in read
    return self._read_chunked(amt)
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 612, in _read_chunked
    value.append(self._safe_read(chunk_left))
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/httplib.py", line 658, in _safe_read
    chunk = self.fp.read(min(amt, MAXAMOUNT))
  File "/home/rtdean/.pyenv/versions/2.7.6/lib/python2.7/socket.py", line 380, in read
    data = self._sock.recv(left)
 
... (truncated)
```

### Output

```
Now I have enough context. Based on the stack trace from the issue and the current code, I can see that:

1. The `generate()` function inside `iter_content()` (lines 816-837) already catches several exceptions like `ProtocolError`, `DecodeError`, `ReadTimeoutError`, and `SSLError`
2. However, it doesn't catch `socket.error` which can occur when reading from `self.raw.stream()` or `self.raw.read()`
3. The issue shows a `socket.error` bubbling up from the standard library during chunked reading

I need to add exception handling for `socket.error` in the `generate()` function. In Python 3, `socket.error` is an alias for `OSError`, but we should handle both for compatibility.

--- a/requests/models.py
+++ b/requests/models.py
@@ -6,6 +6,7 @@
 """
 
 import datetime
+import socket
 
 # Import encoding now, to avoid implicit import later.
 # Implicit import within threads may cause LookupError when standard library is in a ZIP,
@@ -826,6 +827,8 @@ class Response:
                     raise ConnectionError(e)
                 except SSLError as e:
                     raise RequestsSSLError(e)
+                except (socket.error, OSError) as e:
+                    raise ConnectionError(e)
             else:
                 # Standard file-like object.
                 while True:
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:56:27.585564
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

