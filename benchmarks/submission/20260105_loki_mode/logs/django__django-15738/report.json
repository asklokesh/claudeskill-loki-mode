{
  "instance_id": "django__django-15738",
  "model_name_or_path": "loki-mode-sonnet",
  "model_patch": "Based on the architect's analysis and understanding of the Django migration autodetector, I'll generate the patch. The issue is that when a field is changed from ForeignKey to ManyToManyField with the same name while removing unique_together, the operations are generated in the wrong order. The fix needs to ensure that fields being replaced (same name, different type) are properly tracked so the dependency ordering works correctly.\n\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -164,11 +164,25 @@ class MigrationAutodetector:\n         self.kept_proxy_keys = self.new_proxy_keys & self.old_proxy_keys\n         self.kept_unmanaged_keys = self.new_unmanaged_keys & self.old_unmanaged_keys\n         self.through_users = {}\n         self.old_field_keys = set()\n         self.new_field_keys = set()\n         for app_label, model_name in self.kept_model_keys:\n             old_model_name = self.renamed_models.get((app_label, model_name), model_name)\n             old_model_state = self.from_state.models[app_label, old_model_name]\n             new_model_state = self.to_state.models[app_label, model_name]\n             self.old_field_keys.update(\n                 (app_label, model_name, field_name)\n                 for field_name in old_model_state.fields\n             )\n             self.new_field_keys.update(\n                 (app_label, model_name, field_name)\n-                for field_name in new_model_state.fields\n+                for field_name, field in new_model_state.fields.items()\n+                if (\n+                    field_name not in old_model_state.fields or\n+                    # Treat as a new field if replacing a non-M2M field\n+                    # with a M2M field of the same name (e.g., FK -> M2M).\n+                    (\n+                        field_name in old_model_state.fields and\n+                        field.many_to_many and\n+                        not old_model_state.fields[field_name].many_to_many\n+                    )\n+                )\n             )",
  "attempts": 1,
  "success": true,
  "error": null,
  "timestamp": "2026-01-05T19:10:43.645215"
}