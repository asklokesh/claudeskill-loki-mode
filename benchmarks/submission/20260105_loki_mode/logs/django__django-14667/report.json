{
  "instance_id": "django__django-14667",
  "model_name_or_path": "loki-mode-sonnet",
  "model_patch": "Perfect! This looks like it's addressing exactly the issue described. Let me verify this is the correct patch by understanding the logic:\n\nThe issue is in `django/db/models/sql/query.py` in the `set_deferred_loading` method. When `defer()` is called after `only()`:\n\n1. `existing` contains the fields from `only()`\n2. `field_names` contains the fields to defer\n3. When all fields in `existing` are being deferred, `new_existing` becomes empty\n4. The original code would just set `self.deferred_loading = field_names, True`\n5. But if `field_names` contains fields NOT in the original `only()` set, those should still be deferred\n\nThe fix:\n- Calculate `new_defer = field_names.difference(existing)` - fields being deferred that weren't in the `only()` set\n- Update the condition to `if (new_existing := existing.difference(field_names)) or new_defer:`\n- In the else branch, use `new_defer` instead of `field_names`\n\nThis ensures that when `only(\"name\").defer(\"name\").defer(\"country\")` is called, the `country` field (which wasn't in the original `only()` set) is still tracked as deferred.\n\nNow let me generate the clean patch output:\n\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -2102,10 +2102,12 @@ class Query(BaseExpression):\n         if defer:\n             # Add to existing deferred names.\n             self.deferred_loading = existing.union(field_names), True\n         else:\n             # Remove names from the set of any existing \"immediate load\" names.\n-            if new_existing := existing.difference(field_names):\n+            # Calculate which deferred fields are NOT in the original only() set\n+            new_defer = field_names.difference(existing)\n+            if (new_existing := existing.difference(field_names)) or new_defer:\n                 self.deferred_loading = new_existing, False\n             else:\n-                self.deferred_loading = field_names, True\n+                self.deferred_loading = new_defer, True",
  "attempts": 1,
  "success": true,
  "error": null,
  "timestamp": "2026-01-05T18:57:56.492059"
}