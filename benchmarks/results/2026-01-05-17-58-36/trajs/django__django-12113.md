# Trajectory: django__django-12113

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:21:33.936939

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:21:12.414376
**Duration:** 10.59s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
admin_views.test_multidb fails with persistent test SQLite database.
Description
	 
		(last modified by Mariusz Felisiak)
	 
I've tried using persistent SQLite databases for the tests (to make use of
--keepdb), but at least some test fails with:
sqlite3.OperationalError: database is locked
This is not an issue when only using TEST["NAME"] with "default" (which is good enough in terms of performance).
diff --git i/tests/test_sqlite.py w/tests/test_sqlite.py
index f1b65f7d01..9ce4e32e14 100644
--- i/tests/test_sqlite.py
+++ w/tests/test_sqlite.py
@@ -15,9 +15,15 @@
 DATABASES = {
	 'default': {
		 'ENGINE': 'django.db.backends.sqlite3',
+		'TEST': {
+			'NAME': 'test_default.sqlite3'
+		},
	 },
	 'other': {
		 'ENGINE': 'django.db.backends.sqlite3',
+		'TEST': {
+			'NAME': 'test_other.sqlite3'
+		},
	 }
 }
% tests/runtests.py admin_views.test_multidb -v 3 --keepdb --parallel 1
…
Operations to perform:
 Synchronize unmigrated apps: admin_views, auth, contenttypes, messages, sessions, staticfiles
 Apply all migrations: admin, sites
Running pre-migrate handlers for application contenttypes
Running pre-migrate handlers for application auth
Running pre-migrate handlers for application sites
Running pre-migrate handlers for application sessions
Running pre-migrate handlers for application admin
Running pre-migrate handlers for application admin_views
Synchronizing apps without migrations:
 Creating tables...
	Running deferred SQL...
Running migrations:
 No migrations to apply.
Running post-migrate handlers for application contenttypes
Running post-migrate handlers for application auth
Running post-migrate handlers for application sites
Running post-migrate handlers for application sessions
Running post-migrate handlers for application admin
Running post-migrate handlers for application admin_views
System check identified no issues (0 silenced).
ERROR
====================================
... (truncated)
```

### Output

```
## Analysis

**Issue**: SQLite persistent test databases (using `TEST["NAME"]`) fail with "database is locked" errors in multi-database tests, specifically `admin_views.test_multidb`. This works fine when using `NAME` directly but fails with `TEST["NAME"]` and `--keepdb`.

**Root Cause**: The database signature calculation in SQLite backend's creation module doesn't properly account for `TEST["NAME"]` settings, causing test databases to have incorrect/colliding signatures that lead to locking issues when multiple databases are involved.

**Files Affected**:
- `django/db/backends/sqlite3/creation.py` - The `test_db_signature()` method needs to be fixed
- `tests/backends/sqlite/test_creation.py` - New test file to add regression tests

**Fix Strategy**: Update `test_db_signature()` in the SQLite creation backend to properly incorporate `TEST["NAME"]` into the signature calculation, ensuring each test database gets a unique signature. The linked PR #11678 shows this requires modifying how the signature is computed when `TEST["NAME"]` is set.

**Edge Cases**: Ensure backward compatibility with existing test setups that don't use `TEST["NAME"]`, and verify multi-database scenarios work correctly with `--keepdb` flag.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:21:33.936771
**Duration:** 21.52s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
admin_views.test_multidb fails with persistent test SQLite database.
Description
	 
		(last modified by Mariusz Felisiak)
	 
I've tried using persistent SQLite databases for the tests (to make use of
--keepdb), but at least some test fails with:
sqlite3.OperationalError: database is locked
This is not an issue when only using TEST["NAME"] with "default" (which is good enough in terms of performance).
diff --git i/tests/test_sqlite.py w/tests/test_sqlite.py
index f1b65f7d01..9ce4e32e14 100644
--- i/tests/test_sqlite.py
+++ w/tests/test_sqlite.py
@@ -15,9 +15,15 @@
 DATABASES = {
	 'default': {
		 'ENGINE': 'django.db.backends.sqlite3',
+		'TEST': {
+			'NAME': 'test_default.sqlite3'
+		},
	 },
	 'other': {
		 'ENGINE': 'django.db.backends.sqlite3',
+		'TEST': {
+			'NAME': 'test_other.sqlite3'
+		},
	 }
 }
% tests/runtests.py admin_views.test_multidb -v 3 --keepdb --parallel 1
…
Operations to perform:
 Synchronize unmigrated apps: admin_views, auth, contenttypes, messages, sessions, staticfiles
 Apply all migrations: admin, sites
Running pre-migrate handlers for application contenttypes
Running pre-migrate handlers for application auth
Running pre-migrate handlers for application sites
Running pre-migrate handlers for application sessions
Running pre-migrate handlers for application admin
Running pre-migrate handlers for application admin_views
Synchronizing apps without migrations:
 Creating tables...
	Running deferred SQL...
Running migrations:
 No migrations to apply.
Running post-migrate handlers for application contenttypes
Running post-migrate handlers for application auth
Running post-migrate handlers for application sites
Running post-migrate handlers for application sessions
Running post-migrate handlers for application admin
Running post-migrate handlers for application admin_views
System check identified no issues (0 silenced).
ERROR
========================
... (truncated)
```

### Output

```
Based on the architect's analysis, I need to generate a patch for the Django SQLite database creation issue. The problem is in the `test_db_signature()` method which doesn't properly account for `TEST["NAME"]` settings. Let me create the patch based on the standard Django structure:

--- a/django/db/backends/sqlite3/creation.py
+++ b/django/db/backends/sqlite3/creation.py
@@ -89,7 +89,10 @@ class DatabaseCreation(BaseDatabaseCreation):
         settings_dict = self.connection.settings_dict
         return (
             settings_dict['HOST'],
-            settings_dict['NAME'],
+            settings_dict.get('TEST', {}).get('NAME') or settings_dict['NAME'],
         )
 
     def _get_test_db_name(self):
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:21:33.936805
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

