# Trajectory: mwaskom__seaborn-2848

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:48:59.795260

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:48:17.263294
**Duration:** 10.4s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: mwaskom/seaborn
ISSUE:
pairplot fails with hue_order not containing all hue values in seaborn 0.11.1
In seaborn < 0.11, one could plot only a subset of the values in the hue column, by passing a hue_order list containing only the desired values. Points with hue values not in the list were simply not plotted.
```python
iris = sns.load_dataset("iris")`
# The hue column contains three different species; here we want to plot two
sns.pairplot(iris, hue="species", hue_order=["setosa", "versicolor"])
```

This no longer works in 0.11.1. Passing a hue_order list that does not contain some of the values in the hue column raises a long, ugly error traceback. The first exception arises in seaborn/_core.py:
```
TypeError: ufunc 'isnan' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
```
seaborn version: 0.11.1
matplotlib version: 3.3.2
matplotlib backends: MacOSX, Agg or jupyter notebook inline.

HINTS:
The following workarounds seem to work:
```
g.map(sns.scatterplot, hue=iris["species"], hue_order=iris["species"].unique())
```
or
```
g.map(lambda x, y, **kwargs: sns.scatterplot(x=x, y=y, hue=iris["species"]))
```
> ```
> g.map(sns.scatterplot, hue=iris["species"], hue_order=iris["species"].unique())
> ```

The workaround fixes the problem for me.
Thank you very much!

@mwaskom Should I close the Issue or leave it open until the bug is fixed?
That's a good workaround, but it's still a bug. The problem is that `PairGrid` now lets `hue` at the grid-level delegate to the axes-level functions if they have `hue` in their signature. But it's not properly handling the case where `hue` is *not* set for the grid, but *is* specified for one mapped function. @jhncls's workaround suggests the fix.

An easier workaround would have been to set `PairGrid(..., hue="species")` and then pass `.map(..., hue=None)` where you
... (truncated)
```

### Output

```
## Analysis

**Bug**: In seaborn 0.11.1, `pairplot` crashes when `hue_order` contains a subset of `hue` values. Previously, points with hue values not in `hue_order` were simply excluded from plotting. The error occurs in `seaborn/_core.py` with a TypeError about 'isnan' not supporting the input types.

**Root Cause**: `PairGrid` now delegates `hue` handling to axes-level functions, but fails when `hue` is NOT set at the grid level but IS specified for a mapped function. The grid tries to process hue data without proper filtering based on `hue_order`.

**Files Affected**: 
- `seaborn/axisgrid.py` (PairGrid class, likely in the `map()` method or hue delegation logic)
- Possibly `seaborn/_core.py` (where the actual TypeError occurs during type coercion)

**Fix Strategy**: Filter the data to only include rows where the hue column values are in `hue_order` before passing to plotting functions, or ensure proper categorical type handling when `hue_order` is a subset. The workaround suggests passing filtered hue data directly to the mapping function works, so the fix likely involves applying similar filtering in PairGrid's delegation logic.

**Edge Cases**: Ensure behavior works when hue is set at grid level vs function level, and when `hue_order=None`.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:48:59.794528
**Duration:** 42.53s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: mwaskom/seaborn
ISSUE:
pairplot fails with hue_order not containing all hue values in seaborn 0.11.1
In seaborn < 0.11, one could plot only a subset of the values in the hue column, by passing a hue_order list containing only the desired values. Points with hue values not in the list were simply not plotted.
```python
iris = sns.load_dataset("iris")`
# The hue column contains three different species; here we want to plot two
sns.pairplot(iris, hue="species", hue_order=["setosa", "versicolor"])
```

This no longer works in 0.11.1. Passing a hue_order list that does not contain some of the values in the hue column raises a long, ugly error traceback. The first exception arises in seaborn/_core.py:
```
TypeError: ufunc 'isnan' not supported for the input types, and the inputs could not be safely coerced to any supported types according to the casting rule ''safe''
```
seaborn version: 0.11.1
matplotlib version: 3.3.2
matplotlib backends: MacOSX, Agg or jupyter notebook inline.

ARCHITECT'S ANALYSIS:
## Analysis

**Bug**: In seaborn 0.11.1, `pairplot` crashes when `hue_order` contains a subset of `hue` values. Previously, points with hue values not in `hue_order` were simply excluded from plotting. The error occurs in `seaborn/_core.py` with a TypeError about 'isnan' not supporting the input types.

**Root Cause**: `PairGrid` now delegates `hue` handling to axes-level functions, but fails when `hue` is NOT set at the grid level but IS specified for a mapped function. The grid tries to process hue data without proper filtering based on `hue_order`.

**Files Affected**: 
- `seaborn/axisgrid.py` (PairGrid class, likely in the `map()` method or hue delegation logic)
- Possibly `seaborn/_core.py` (where the actual TypeError occurs during type coercion)

**Fix Strategy**: Filter the data to only include rows where the hue column values are in `hue_order` before passing to plotting functions, or ens
... (truncated)
```

### Output

```
Based on the context, I understand this is a SWE-bench benchmark where I need to generate a patch for the seaborn issue mwaskom__seaborn-2848. The issue is about `pairplot` failing when `hue_order` doesn't contain all hue values.

Looking at the existing patch that was generated, I can see the format. However, I need to generate a clean patch without any explanatory text, just the raw unified diff format.

Based on the architect's analysis and the issue description:
- The bug is in `PairGrid` class in `seaborn/axisgrid.py`
- When `hue_order` is a subset of hue values, data should be filtered to only include rows where the hue column values are in `hue_order`
- This filtering should happen before hue delegation to axes-level functions

--- a/seaborn/axisgrid.py
+++ b/seaborn/axisgrid.py
@@ -1287,6 +1287,11 @@ class PairGrid(Grid):
         self._extract_legend_handles = True
 
         self._hue_var = hue
+
+        # Filter data to only include rows with hue values in hue_order
+        if hue is not None and hue_order is not None:
+            data = data[data[hue].isin(hue_order)]
+            self.data = data
+
         if hue is None:
             self.hue_names = None
             self.hue_vals = None
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:48:59.794768
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

