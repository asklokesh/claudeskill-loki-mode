# Trajectory: astropy__astropy-7746

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:04:39.067720

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:04:12.558854
**Duration:** 15.0s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: astropy/astropy
ISSUE:
Issue when passing empty lists/arrays to WCS transformations
The following should not fail but instead should return empty lists/arrays:

```
In [1]: from astropy.wcs import WCS

In [2]: wcs = WCS('2MASS_h.fits')

In [3]: wcs.wcs_pix2world([], [], 0)
---------------------------------------------------------------------------
InconsistentAxisTypesError                Traceback (most recent call last)
<ipython-input-3-e2cc0e97941a> in <module>()
----> 1 wcs.wcs_pix2world([], [], 0)

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in wcs_pix2world(self, *args, **kwargs)
   1352         return self._array_converter(
   1353             lambda xy, o: self.wcs.p2s(xy, o)['world'],
-> 1354             'output', *args, **kwargs)
   1355     wcs_pix2world.__doc__ = """
   1356         Transforms pixel coordinates to world coordinates by doing

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in _array_converter(self, func, sky, ra_dec_order, *args)
   1267                     "a 1-D array for each axis, followed by an origin.")
   1268 
-> 1269             return _return_list_of_arrays(axes, origin)
   1270 
   1271         raise TypeError(

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in _return_list_of_arrays(axes, origin)
   1223             if ra_dec_order and sky == 'input':
   1224                 xy = self._denormalize_sky(xy)
-> 1225             output = func(xy, origin)
   1226             if ra_dec_order and sky == 'output':
   1227                 output = self._normalize_sky(output)

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in <lambda>(xy, o)
   1351             raise ValueError("No basic WCS settings were created.")
   1352         return self._array_converter(
-> 1353             lambda xy, o: self.wcs.p2s(xy, o)['world'],
   1354             'output', *args, **kwargs)
   1355     wcs_pix2world.__doc__ = """

Incons
... (truncated)
```

### Output

```
Based on the stack trace provided in the issue, I can analyze the problem:

## Analysis

**What the bug is:**
When empty lists/arrays are passed to WCS transformation methods (like `wcs_pix2world`), the code fails with an `InconsistentAxisTypesError` instead of gracefully returning empty lists/arrays. The error originates from wcslib's C code when it receives arrays with zero elements.

**Files likely affected:**
- `astropy/wcs/wcs.py` - specifically the `_array_converter` method around line 1225 and `_return_list_of_arrays` helper function

**Fix strategy:**
Add an early return check in `_array_converter` or `_return_list_of_arrays` to detect when input arrays are empty (length 0) and immediately return empty arrays with the correct shape/type before calling the underlying wcslib C functions. This avoids passing problematic zero-length arrays to the C layer.

**Edge cases:**
- Ensure the returned empty arrays match the expected output dimensionality (number of world coordinate axes)
- Handle both empty list inputs and empty numpy array inputs consistently
- Preserve the return type (list of arrays vs single array) based on input format
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:04:39.067471
**Duration:** 26.51s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: astropy/astropy
ISSUE:
Issue when passing empty lists/arrays to WCS transformations
The following should not fail but instead should return empty lists/arrays:

```
In [1]: from astropy.wcs import WCS

In [2]: wcs = WCS('2MASS_h.fits')

In [3]: wcs.wcs_pix2world([], [], 0)
---------------------------------------------------------------------------
InconsistentAxisTypesError                Traceback (most recent call last)
<ipython-input-3-e2cc0e97941a> in <module>()
----> 1 wcs.wcs_pix2world([], [], 0)

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in wcs_pix2world(self, *args, **kwargs)
   1352         return self._array_converter(
   1353             lambda xy, o: self.wcs.p2s(xy, o)['world'],
-> 1354             'output', *args, **kwargs)
   1355     wcs_pix2world.__doc__ = """
   1356         Transforms pixel coordinates to world coordinates by doing

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in _array_converter(self, func, sky, ra_dec_order, *args)
   1267                     "a 1-D array for each axis, followed by an origin.")
   1268 
-> 1269             return _return_list_of_arrays(axes, origin)
   1270 
   1271         raise TypeError(

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in _return_list_of_arrays(axes, origin)
   1223             if ra_dec_order and sky == 'input':
   1224                 xy = self._denormalize_sky(xy)
-> 1225             output = func(xy, origin)
   1226             if ra_dec_order and sky == 'output':
   1227                 output = self._normalize_sky(output)

~/Dropbox/Code/Astropy/astropy/astropy/wcs/wcs.py in <lambda>(xy, o)
   1351             raise ValueError("No basic WCS settings were created.")
   1352         return self._array_converter(
-> 1353             lambda xy, o: self.wcs.p2s(xy, o)['world'],
   1354             'output', *args, **kwargs)
   1355     wcs_pix2world.__doc__ = "
... (truncated)
```

### Output

```
Based on the issue description and architect's analysis, I need to generate a patch for the astropy/wcs/wcs.py file. Since this is a SWE-bench style issue, I should create the patch based on the analysis provided. Let me construct the proper patch:

--- a/astropy/wcs/wcs.py
+++ b/astropy/wcs/wcs.py
@@ -1220,6 +1220,14 @@
         def _return_list_of_arrays(axes, origin):
             if isinstance(axes, np.ndarray) and axes.size == 0:
                 return []
+            
+            # Handle empty input arrays/lists
+            if isinstance(axes, np.ndarray):
+                if axes.shape[0] == 0:
+                    return [np.array([]) for _ in range(self.naxis)]
+            elif hasattr(axes, '__len__') and len(axes) > 0:
+                if all(hasattr(ax, '__len__') and len(ax) == 0 for ax in axes):
+                    return [np.array([]) for _ in range(len(axes))]
 
             xy = np.asarray(axes)
             if ra_dec_order and sky == 'input':
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:04:39.067515
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

