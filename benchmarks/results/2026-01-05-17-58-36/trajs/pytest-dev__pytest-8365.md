# Trajectory: pytest-dev__pytest-8365

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T20:25:28.359061

---

## Step 1: Architect

**Timestamp:** 2026-01-05T20:24:55.150570
**Duration:** 8.28s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: pytest-dev/pytest
ISSUE:
tmpdir creation fails when the username contains illegal characters for directory names
`tmpdir`, `tmpdir_factory` and `tmp_path_factory` rely on `getpass.getuser()` for determining the `basetemp` directory. I found that the user name returned by `getpass.getuser()` may return characters that are not allowed for directory names. This may lead to errors while creating the temporary directory.

The situation in which I reproduced this issue was while being logged in through an ssh connection into my Windows 10 x64 Enterprise version (1909) using an OpenSSH_for_Windows_7.7p1 server. In this configuration the command `python -c "import getpass; print(getpass.getuser())"` returns my domain username e.g. `contoso\john_doe` instead of `john_doe` as when logged in regularly using a local session.

When trying to create a temp directory in pytest through e.g. `tmpdir_factory.mktemp('foobar')` this fails with the following error message:
```
self = WindowsPath('C:/Users/john_doe/AppData/Local/Temp/pytest-of-contoso/john_doe')
mode = 511, parents = False, exist_ok = True

    def mkdir(self, mode=0o777, parents=False, exist_ok=False):
        """
        Create a new directory at this given path.
        """
        if self._closed:
            self._raise_closed()
        try:
>           self._accessor.mkdir(self, mode)
E           FileNotFoundError: [WinError 3] The system cannot find the path specified: 'C:\\Users\\john_doe\\AppData\\Local\\Temp\\pytest-of-contoso\\john_doe'

C:\Python38\lib\pathlib.py:1266: FileNotFoundError
```

I could also reproduce this without the complicated ssh/windows setup with pytest 6.2.2 using the following commands from a `cmd`:
```bat
echo def test_tmpdir(tmpdir):>test_tmp.py
echo   pass>>test_tmp.py
set LOGNAME=contoso\john_doe
py.test test_tmp.py
```

Thanks for having a look at this!


HINTS:
Thanks for the report @pbo
... (truncated)
```

### Output

```
Based on the issue analysis:

**Bug**: `tmpdir`/`tmpdir_factory`/`tmp_path_factory` use `getpass.getuser()` which can return usernames with illegal directory characters (e.g., `contoso\john_doe` with backslash on Windows), causing `FileNotFoundError` when creating temp directories.

**Files likely affected**: 
- `src/_pytest/tmpdir.py` (contains tmpdir fixture implementations and basetemp path construction)

**Fix strategy**: Sanitize the username returned by `getpass.getuser()` before using it in directory paths. Replace or remove illegal filesystem characters (backslash, forward slash, colon, etc.) with safe alternatives like underscores or hyphens to ensure valid directory names across platforms.

**Edge cases**: Consider cross-platform illegal characters (Windows has more restrictions than Unix), empty usernames after sanitization, and preserving uniqueness if multiple users map to same sanitized name.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T20:25:28.358606
**Duration:** 33.21s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: pytest-dev/pytest
ISSUE:
tmpdir creation fails when the username contains illegal characters for directory names
`tmpdir`, `tmpdir_factory` and `tmp_path_factory` rely on `getpass.getuser()` for determining the `basetemp` directory. I found that the user name returned by `getpass.getuser()` may return characters that are not allowed for directory names. This may lead to errors while creating the temporary directory.

The situation in which I reproduced this issue was while being logged in through an ssh connection into my Windows 10 x64 Enterprise version (1909) using an OpenSSH_for_Windows_7.7p1 server. In this configuration the command `python -c "import getpass; print(getpass.getuser())"` returns my domain username e.g. `contoso\john_doe` instead of `john_doe` as when logged in regularly using a local session.

When trying to create a temp directory in pytest through e.g. `tmpdir_factory.mktemp('foobar')` this fails with the following error message:
```
self = WindowsPath('C:/Users/john_doe/AppData/Local/Temp/pytest-of-contoso/john_doe')
mode = 511, parents = False, exist_ok = True

    def mkdir(self, mode=0o777, parents=False, exist_ok=False):
        """
        Create a new directory at this given path.
        """
        if self._closed:
            self._raise_closed()
        try:
>           self._accessor.mkdir(self, mode)
E           FileNotFoundError: [WinError 3] The system cannot find the path specified: 'C:\\Users\\john_doe\\AppData\\Local\\Temp\\pytest-of-contoso\\john_doe'

C:\Python38\lib\pathlib.py:1266: FileNotFoundError
```

I could also reproduce this without the complicated ssh/windows setup with pytest 6.2.2 using the following commands from a `cmd`:
```bat
echo def test_tmpdir(tmpdir):>test_tmp.py
echo   pass>>test_tmp.py
set LOGNAME=contoso\john_doe
py.test test_tmp.py
```

Thanks for having a look at this!


ARCHITECT'S ANALYSIS:
... (truncated)
```

### Output

```
I see this is the claudeskill-loki-mode repository, not a pytest repository. The task is asking me to generate a patch for a pytest issue, but I need to work with a hypothetical pytest codebase structure. Let me create the appropriate patch based on the standard pytest tmpdir.py implementation.

--- a/src/_pytest/tmpdir.py
+++ b/src/_pytest/tmpdir.py
@@ -1,6 +1,7 @@
 """Support for providing temporary directories to test functions."""
 import os
 import re
+import re
 import tempfile
 from pathlib import Path
 from typing import Optional
@@ -87,11 +88,23 @@ def get_user() -> Optional[str]:
     """Return the current user name, or None if getuser() does not work
     in the current environment (see #1010).
     """
+    def sanitize_username(username: str) -> str:
+        """Sanitize username to remove characters illegal in directory names.
+        
+        Replaces illegal filesystem characters with underscores to ensure
+        valid directory names across platforms (especially Windows).
+        """
+        # Replace illegal characters (backslash, forward slash, colon, etc.) with underscore
+        # Windows illegal chars: < > : " / \ | ? *
+        # Also replace null bytes and control characters
+        sanitized = re.sub(r'[\x00-\x1f<>:"/\\|?*]', '_', username)
+        return sanitized
+
     try:
         import getpass
 
-        return getpass.getuser()
+        username = getpass.getuser()
+        return sanitize_username(username) if username else None
     except (ImportError, KeyError):
         return None
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T20:25:28.358684
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

