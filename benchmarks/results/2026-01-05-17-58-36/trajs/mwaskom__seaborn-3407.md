# Trajectory: mwaskom__seaborn-3407

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:51:29.733537

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:50:47.831787
**Duration:** 9.0s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: mwaskom/seaborn
ISSUE:
pairplot raises KeyError with MultiIndex DataFrame
When trying to pairplot a MultiIndex DataFrame, `pairplot` raises a `KeyError`:

MRE:

```python
import numpy as np
import pandas as pd
import seaborn as sns


data = {
    ("A", "1"): np.random.rand(100),
    ("A", "2"): np.random.rand(100),
    ("B", "1"): np.random.rand(100),
    ("B", "2"): np.random.rand(100),
}
df = pd.DataFrame(data)
sns.pairplot(df)
```

Output:

```
[c:\Users\KLuu\anaconda3\lib\site-packages\seaborn\axisgrid.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/seaborn/axisgrid.py) in pairplot(data, hue, hue_order, palette, vars, x_vars, y_vars, kind, diag_kind, markers, height, aspect, corner, dropna, plot_kws, diag_kws, grid_kws, size)
   2142     diag_kws.setdefault("legend", False)
   2143     if diag_kind == "hist":
-> 2144         grid.map_diag(histplot, **diag_kws)
   2145     elif diag_kind == "kde":
   2146         diag_kws.setdefault("fill", True)

[c:\Users\KLuu\anaconda3\lib\site-packages\seaborn\axisgrid.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/seaborn/axisgrid.py) in map_diag(self, func, **kwargs)
   1488                 plt.sca(ax)
   1489 
-> 1490             vector = self.data[var]
   1491             if self._hue_var is not None:
   1492                 hue = self.data[self._hue_var]

[c:\Users\KLuu\anaconda3\lib\site-packages\pandas\core\frame.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/pandas/core/frame.py) in __getitem__(self, key)
   3765             if is_iterator(key):
   3766                 key = list(key)
-> 3767             indexer = self.columns._get_indexer_strict(key, "columns")[1]
   3768 
   3769         # take() does not accept boolean indexers

[c:\Users\KLuu\anaconda3\lib\site-packages\pandas\core\indexes\multi.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/pandas/core/indexes/multi.py) in _get
... (truncated)
```

### Output

```
## Analysis

**Issue**: `pairplot` fails with MultiIndex DataFrames because it tries to access columns using string keys, but MultiIndex columns require tuple keys like `("A", "1")`.

**Root Cause**: In `axisgrid.py:1490`, the code does `self.data[var]` where `var` is a string representation of the MultiIndex tuple rather than the actual tuple key.

**Files Affected**:
- `seaborn/axisgrid.py` - specifically the `PairGrid` class and its `map_diag` method (and likely `map_offdiag`, `map_lower`, `map_upper` methods)

**Fix Strategy**: 
When a DataFrame with MultiIndex columns is passed, store the actual column objects (tuples) in the internal variable lists instead of converting them to strings. The column iteration logic needs to preserve the original MultiIndex tuple structure for proper DataFrame indexing.

**Edge Cases**: 
- Mixed single-level and multi-level column names
- `hue` parameter with MultiIndex columns
- `vars`, `x_vars`, `y_vars` parameters need to handle both tuple and string inputs
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:51:29.733174
**Duration:** 41.9s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: mwaskom/seaborn
ISSUE:
pairplot raises KeyError with MultiIndex DataFrame
When trying to pairplot a MultiIndex DataFrame, `pairplot` raises a `KeyError`:

MRE:

```python
import numpy as np
import pandas as pd
import seaborn as sns


data = {
    ("A", "1"): np.random.rand(100),
    ("A", "2"): np.random.rand(100),
    ("B", "1"): np.random.rand(100),
    ("B", "2"): np.random.rand(100),
}
df = pd.DataFrame(data)
sns.pairplot(df)
```

Output:

```
[c:\Users\KLuu\anaconda3\lib\site-packages\seaborn\axisgrid.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/seaborn/axisgrid.py) in pairplot(data, hue, hue_order, palette, vars, x_vars, y_vars, kind, diag_kind, markers, height, aspect, corner, dropna, plot_kws, diag_kws, grid_kws, size)
   2142     diag_kws.setdefault("legend", False)
   2143     if diag_kind == "hist":
-> 2144         grid.map_diag(histplot, **diag_kws)
   2145     elif diag_kind == "kde":
   2146         diag_kws.setdefault("fill", True)

[c:\Users\KLuu\anaconda3\lib\site-packages\seaborn\axisgrid.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/seaborn/axisgrid.py) in map_diag(self, func, **kwargs)
   1488                 plt.sca(ax)
   1489 
-> 1490             vector = self.data[var]
   1491             if self._hue_var is not None:
   1492                 hue = self.data[self._hue_var]

[c:\Users\KLuu\anaconda3\lib\site-packages\pandas\core\frame.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/pandas/core/frame.py) in __getitem__(self, key)
   3765             if is_iterator(key):
   3766                 key = list(key)
-> 3767             indexer = self.columns._get_indexer_strict(key, "columns")[1]
   3768 
   3769         # take() does not accept boolean indexers

[c:\Users\KLuu\anaconda3\lib\site-packages\pandas\core\indexes\multi.py](file:///C:/Users/KLuu/anaconda3/lib/site-packages/pandas/core/indexes/multi
... (truncated)
```

### Output

```
I understand now. This is a task where I need to generate a patch for a seaborn issue, but I'm in a different repository. Based on the issue description and architect's analysis, I need to create a patch that fixes the MultiIndex DataFrame issue in seaborn's axisgrid.py file.

Let me create the patch based on the analysis provided:

--- a/seaborn/axisgrid.py
+++ b/seaborn/axisgrid.py
@@ -1322,7 +1322,7 @@
 
         # Assemble the list of variables to use
         if vars is not None:
-            x_vars = list(vars)
+            x_vars = list(vars) if not isinstance(data.columns, pd.MultiIndex) else [col for col in data.columns if col in vars or str(col) in vars]
             y_vars = list(vars)
         else:
             if data is not None:
@@ -1332,9 +1332,9 @@
             else:
                 numeric_cols = []
             if x_vars is None:
-                x_vars = numeric_cols
+                x_vars = list(numeric_cols)
             if y_vars is None:
-                y_vars = numeric_cols
+                y_vars = list(numeric_cols)
 
         if not x_vars:
             raise ValueError("No variables found for grid columns.")
@@ -1361,13 +1361,27 @@
         # Set up the data and hue_var handling
         self.data = data
         self._hue_var = hue
-        self.hue_vals = pd.Series(index=data.index, dtype=object)
+        
+        # Handle MultiIndex columns by preserving original column objects
+        if isinstance(data.columns, pd.MultiIndex):
+            # Ensure x_vars and y_vars contain actual MultiIndex tuples
+            self.x_vars = [col if isinstance(col, tuple) else col for col in x_vars]
+            self.y_vars = [col if isinstance(col, tuple) else col for col in y_vars]
+            
+            # Map string representations to actual tuple keys if needed
+            str_to_col = {str(col): col for col in data.columns}
+            self.x_vars = [str_to_col.get(var, var) if isinstance(var, str) and var in str_to_col else var for var in self.x_vars]
+            self.y_vars = [str_to_col.get(var, var) if isinstance(var, str) and var in str_to_col else var for var in self.y_vars]
+        else:
+            self.x_vars = x_vars
+            self.y_vars = y_vars
 
         if hue is not None:
+            hue_col = hue if not isinstance(data.columns, pd.MultiIndex) or isinstance(hue, tuple) else str_to_col.get(hue, hue) if isinstance(hue, str) else hue
+            hue_data = data[hue_col]
             hue_order = self._initialize_hue_order(
-                data, hue, hue_order, palette
+                {hue_col: hue_data}, hue_col, hue_order, palette
             )
-            hue_data = self.data[hue]
             self.hue_names = hue_order
             self.hue_vals = hue_data.to_numpy()
             self.hue_kws = self._hue_kws(palette, self.n_colors)
@@ -1376,10 +1390,6 @@
             self.hue_vals = None
             self.hue_kws = {}
 
-        # Now we can set x_vars and y_vars
-        self.x_vars = x_vars
-        self.y_vars = y_vars
-
         self.square_grid = self.x_vars == self.y_vars
 
         # Set up the lists of matplotlib axes
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:51:29.733241
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

