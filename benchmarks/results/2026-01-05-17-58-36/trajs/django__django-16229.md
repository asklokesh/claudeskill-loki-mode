# Trajectory: django__django-16229

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:20:08.827391

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:19:49.868090
**Duration:** 9.74s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
ModelForm fields with callable defaults don't correctly propagate default values
Description
	
When creating an object via the admin, if an inline contains an ArrayField in error, the validation will be bypassed (and the inline dismissed) if we submit the form a second time (without modification).
go to /admin/my_app/thing/add/
type anything in plop
submit -> it shows an error on the inline
submit again -> no errors, plop become unfilled
# models.py
class Thing(models.Model):
	pass
class RelatedModel(models.Model):
	thing = models.ForeignKey(Thing, on_delete=models.CASCADE)
	plop = ArrayField(
		models.CharField(max_length=42),
		default=list,
	)
# admin.py
class RelatedModelForm(forms.ModelForm):
	def clean(self):
		raise ValidationError("whatever")
class RelatedModelInline(admin.TabularInline):
	form = RelatedModelForm
	model = RelatedModel
	extra = 1
@admin.register(Thing)
class ThingAdmin(admin.ModelAdmin):
	inlines = [
		RelatedModelInline
	]
It seems related to the hidden input containing the initial value:
<input type="hidden" name="initial-relatedmodel_set-0-plop" value="test" id="initial-relatedmodel_set-0-id_relatedmodel_set-0-plop">
I can fix the issue locally by forcing show_hidden_initial=False on the field (in the form init)


HINTS:
First submit
Second submit
Can you reproduce this issue with Django 4.1? (or with the current main branch). Django 3.2 is in extended support so it doesn't receive bugfixes anymore (except security patches).
Replying to Mariusz Felisiak: Can you reproduce this issue with Django 4.1? (or with the current main branch). Django 3.2 is in extended support so it doesn't receive bugfixes anymore (except security patches). Same issue with Django 4.1.2

Your job:
1. Understand what the issue is about
2. Identify which file(s) likely need to be changed
3. Describe the fix approach (2-3 sentences)
4. Note any edge cases

Output a brief analysis (5
... (truncated)
```

### Output

```
## Analysis

**Bug**: When a ModelForm field with a callable default (like `default=list`) has validation errors in an admin inline, submitting the form a second time without changes bypasses validation and clears the field value. The issue occurs because the hidden initial value input uses the callable itself rather than calling it to get the actual default value.

**Files affected**:
- `django/forms/models.py` (ModelFormMetaclass or BaseModelForm's field initialization)
- Possibly `django/forms/fields.py` or `django/forms/boundfield.py` (hidden initial widget handling)

**Fix strategy**: When constructing form fields from model fields with callable defaults, ensure the callable is invoked to get the actual initial value before it's used for the hidden initial input. The form should call the default function and use its return value instead of serializing the function object itself.

**Edge cases**: 
- Ensure callable defaults that take arguments aren't broken
- Verify non-callable defaults still work correctly
- Check that `show_hidden_initial` behavior remains consistent for other field types
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:20:08.827040
**Duration:** 18.96s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
ModelForm fields with callable defaults don't correctly propagate default values
Description
	
When creating an object via the admin, if an inline contains an ArrayField in error, the validation will be bypassed (and the inline dismissed) if we submit the form a second time (without modification).
go to /admin/my_app/thing/add/
type anything in plop
submit -> it shows an error on the inline
submit again -> no errors, plop become unfilled
# models.py
class Thing(models.Model):
	pass
class RelatedModel(models.Model):
	thing = models.ForeignKey(Thing, on_delete=models.CASCADE)
	plop = ArrayField(
		models.CharField(max_length=42),
		default=list,
	)
# admin.py
class RelatedModelForm(forms.ModelForm):
	def clean(self):
		raise ValidationError("whatever")
class RelatedModelInline(admin.TabularInline):
	form = RelatedModelForm
	model = RelatedModel
	extra = 1
@admin.register(Thing)
class ThingAdmin(admin.ModelAdmin):
	inlines = [
		RelatedModelInline
	]
It seems related to the hidden input containing the initial value:
<input type="hidden" name="initial-relatedmodel_set-0-plop" value="test" id="initial-relatedmodel_set-0-id_relatedmodel_set-0-plop">
I can fix the issue locally by forcing show_hidden_initial=False on the field (in the form init)


ARCHITECT'S ANALYSIS:
## Analysis

**Bug**: When a ModelForm field with a callable default (like `default=list`) has validation errors in an admin inline, submitting the form a second time without changes bypasses validation and clears the field value. The issue occurs because the hidden initial value input uses the callable itself rather than calling it to get the actual default value.

**Files affected**:
- `django/forms/models.py` (ModelFormMetaclass or BaseModelForm's field initialization)
- Possibly `django/forms/fields.py` or `django/forms/boundfield.py` (hidden initial widget handling)

**Fix strategy**: When constructing fo
... (truncated)
```

### Output

```
--- a/django/forms/models.py
+++ b/django/forms/models.py
@@ -91,6 +91,9 @@ def fields_for_model(
             continue
         kwargs = {}
+        # Fields with callable defaults should not show hidden initial.
+        if f.has_default() and callable(f.default):
+            kwargs["show_hidden_initial"] = False
         if widgets and f.name in widgets:
             kwargs["widget"] = widgets[f.name]
         if localized_fields == ALL_FIELDS or (
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:20:08.827095
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

