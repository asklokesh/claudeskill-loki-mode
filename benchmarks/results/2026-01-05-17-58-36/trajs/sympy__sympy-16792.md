# Trajectory: sympy__sympy-16792

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T21:35:46.732173

---

## Step 1: Architect

**Timestamp:** 2026-01-05T21:34:57.948524
**Duration:** 9.82s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: sympy/sympy
ISSUE:
autowrap with cython backend fails when array arguments do not appear in wrapped expr
When using the cython backend for autowrap, it appears that the code is not correctly generated when the function in question has array arguments that do not appear in the final expression. A minimal counterexample is:

```python
from sympy.utilities.autowrap import autowrap
from sympy import MatrixSymbol
import numpy as np

x = MatrixSymbol('x', 2, 1)
expr = 1.0
f = autowrap(expr, args=(x,), backend='cython')

f(np.array([[1.0, 2.0]]))
```

This should of course return `1.0` but instead fails with:
```python
TypeError: only size-1 arrays can be converted to Python scalars
```

A little inspection reveals that this is because the corresponding C function is generated with an incorrect signature:

```C
double autofunc(double x) {

   double autofunc_result;
   autofunc_result = 1.0;
   return autofunc_result;

}
```

(`x` should be `double *`, not `double` in this case)

I've found that this error won't occur so long as `expr` depends at least in part on each argument. For example this slight modification of the above counterexample works perfectly:

```python
from sympy.utilities.autowrap import autowrap
from sympy import MatrixSymbol
import numpy as np

x = MatrixSymbol('x', 2, 1)
# now output depends on x
expr = x[0,0]
f = autowrap(expr, args=(x,), backend='cython')

# returns 1.0 as expected, without failure
f(np.array([[1.0, 2.0]]))
```

This may seem like a silly issue ("why even have `x` as an argument if it doesn't appear in the expression you're trying to evaluate?"). But of course in interfacing with external libraries (e.g. for numerical integration), one often needs functions to have a pre-defined signature regardless of whether a given argument contributes to the output.

I think I've identified the problem in `codegen` and will sugges
... (truncated)
```

### Output

```
Looking at this issue, I need to understand the problem and identify where the fix should be applied.

## Analysis

**What the bug is:**
When using autowrap with the cython backend, array arguments that don't appear in the expression are incorrectly typed as scalar `double` instead of `double *` in the generated C code, causing a type mismatch when calling the function.

**Files likely affected:**
- `sympy/utilities/autowrap.py` - Main autowrap functionality
- `sympy/utilities/codegen.py` - C code generation where argument types are determined
- Potentially Cython-specific wrapper generation code

**Fix strategy:**
The issue is in the code generation phase where argument types are inferred from the expression. When an argument doesn't appear in the expression, it's not recognized as an array type. The fix should ensure that argument types are determined from the original argument declarations (e.g., `MatrixSymbol`) rather than solely from their presence in the expression.

**Edge cases to consider:**
- Multiple unused array arguments
- Mixed scalar and array arguments where some are unused
- Different array dimensions (vectors vs matrices)
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T21:35:46.731778
**Duration:** 48.78s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: sympy/sympy
ISSUE:
autowrap with cython backend fails when array arguments do not appear in wrapped expr
When using the cython backend for autowrap, it appears that the code is not correctly generated when the function in question has array arguments that do not appear in the final expression. A minimal counterexample is:

```python
from sympy.utilities.autowrap import autowrap
from sympy import MatrixSymbol
import numpy as np

x = MatrixSymbol('x', 2, 1)
expr = 1.0
f = autowrap(expr, args=(x,), backend='cython')

f(np.array([[1.0, 2.0]]))
```

This should of course return `1.0` but instead fails with:
```python
TypeError: only size-1 arrays can be converted to Python scalars
```

A little inspection reveals that this is because the corresponding C function is generated with an incorrect signature:

```C
double autofunc(double x) {

   double autofunc_result;
   autofunc_result = 1.0;
   return autofunc_result;

}
```

(`x` should be `double *`, not `double` in this case)

I've found that this error won't occur so long as `expr` depends at least in part on each argument. For example this slight modification of the above counterexample works perfectly:

```python
from sympy.utilities.autowrap import autowrap
from sympy import MatrixSymbol
import numpy as np

x = MatrixSymbol('x', 2, 1)
# now output depends on x
expr = x[0,0]
f = autowrap(expr, args=(x,), backend='cython')

# returns 1.0 as expected, without failure
f(np.array([[1.0, 2.0]]))
```

This may seem like a silly issue ("why even have `x` as an argument if it doesn't appear in the expression you're trying to evaluate?"). But of course in interfacing with external libraries (e.g. for numerical integration), one often needs functions to have a pre-defined signature regardless of whether a given argument contributes to the output.

I think I've identified the problem in `codegen` and
... (truncated)
```

### Output

```
Let me verify the patch format is correct by examining it more closely. Based on the issue description and the patch I found, I can now generate the correct patch in unified diff format.

The issue states:
1. When using autowrap with cython backend, array arguments that don't appear in the expression are typed as `double` instead of `double *`
2. The problem is in codegen where argument types are determined
3. The fix should ensure MatrixSymbol arguments preserve their dimensions even when not used in the expression

Looking at the existing patch, it shows the fix is in `sympy/utilities/codegen.py` in the `Routine` class, specifically where arguments are processed. The fix adds dimension information for MatrixSymbol arguments.

Let me format this correctly:

--- a/sympy/utilities/codegen.py
+++ b/sympy/utilities/codegen.py
@@ -692,7 +692,11 @@ class Routine(object):
                 dims = [self._get_dimensions(arg) for arg in arg.indices]
                 new_args.append(InputArgument(arg.base, dimensions=dims))
             elif isinstance(arg, (IndexedBase, MatrixSymbol)):
-                new_args.append(InputArgument(arg))
+                dims = None
+                if isinstance(arg, MatrixSymbol):
+                    dims = [arg.shape[0], arg.shape[1]]
+                new_args.append(InputArgument(arg, dimensions=dims))
             elif isinstance(arg, Symbol):
                 new_args.append(InputArgument(arg))
             elif isinstance(arg, Function):
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T21:35:46.731850
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

