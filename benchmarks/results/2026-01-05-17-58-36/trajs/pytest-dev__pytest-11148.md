# Trajectory: pytest-dev__pytest-11148

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T20:15:33.915433

---

## Step 1: Architect

**Timestamp:** 2026-01-05T20:14:55.673734
**Duration:** 10.41s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: pytest-dev/pytest
ISSUE:
Module imported twice under import-mode=importlib
In pmxbot/pmxbot@7f189ad, I'm attempting to switch pmxbot off of pkg_resources style namespace packaging to PEP 420 namespace packages. To do so, I've needed to switch to `importlib` for the `import-mode` and re-organize the tests to avoid import errors on the tests.

Yet even after working around these issues, the tests are failing when the effect of `core.initialize()` doesn't seem to have had any effect.

Investigating deeper, I see that initializer is executed and performs its actions (setting a class variable `pmxbot.logging.Logger.store`), but when that happens, there are two different versions of `pmxbot.logging` present, one in `sys.modules` and another found in `tests.unit.test_commands.logging`:

```
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.11.1, pytest-7.2.0, pluggy-1.0.0
cachedir: .tox/python/.pytest_cache
rootdir: /Users/jaraco/code/pmxbot/pmxbot, configfile: pytest.ini
plugins: black-0.3.12, mypy-0.10.3, jaraco.test-5.3.0, checkdocs-2.9.0, flake8-1.1.1, enabler-2.0.0, jaraco.mongodb-11.2.1, pmxbot-1122.14.3.dev13+g7f189ad
collected 421 items / 180 deselected / 241 selected                                                                                                                       
run-last-failure: rerun previous 240 failures (skipped 14 files)

tests/unit/test_commands.py E
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> traceback >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

cls = <class 'tests.unit.test_commands.TestCommands'>

    @classmethod
    def setup_class(cls):
        path = os.path.dirname(os.path.abspath(__file__))
        configfile = os.path
... (truncated)
```

### Output

```
Based on the issue description and hints, here's my analysis:

**Bug**: Under `import-mode=importlib` with `doctest-modules` enabled, pytest imports the same module twice, creating duplicate module objects. This causes class variables set on one instance to be invisible to code using the other instance.

**Root Cause**: When doctests are collected from a module that's also imported by test files, the import mechanism creates separate module instances instead of reusing the one in `sys.modules`.

**Files Likely Affected**:
- `src/_pytest/doctest.py` - doctest collection/import logic
- `src/_pytest/pathlib.py` or `src/_pytest/python.py` - importlib import mode implementation

**Fix Strategy**: Ensure doctest module imports check and reuse existing `sys.modules` entries when `import-mode=importlib`. The doctest collector likely needs to use the same import mechanism as the test collector to maintain module identity.

**Edge Cases**: Namespace packages (PEP 420), modules imported before pytest runs, circular imports between test modules and source modules.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T20:15:33.915031
**Duration:** 38.24s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: pytest-dev/pytest
ISSUE:
Module imported twice under import-mode=importlib
In pmxbot/pmxbot@7f189ad, I'm attempting to switch pmxbot off of pkg_resources style namespace packaging to PEP 420 namespace packages. To do so, I've needed to switch to `importlib` for the `import-mode` and re-organize the tests to avoid import errors on the tests.

Yet even after working around these issues, the tests are failing when the effect of `core.initialize()` doesn't seem to have had any effect.

Investigating deeper, I see that initializer is executed and performs its actions (setting a class variable `pmxbot.logging.Logger.store`), but when that happens, there are two different versions of `pmxbot.logging` present, one in `sys.modules` and another found in `tests.unit.test_commands.logging`:

```
=========================================================================== test session starts ===========================================================================
platform darwin -- Python 3.11.1, pytest-7.2.0, pluggy-1.0.0
cachedir: .tox/python/.pytest_cache
rootdir: /Users/jaraco/code/pmxbot/pmxbot, configfile: pytest.ini
plugins: black-0.3.12, mypy-0.10.3, jaraco.test-5.3.0, checkdocs-2.9.0, flake8-1.1.1, enabler-2.0.0, jaraco.mongodb-11.2.1, pmxbot-1122.14.3.dev13+g7f189ad
collected 421 items / 180 deselected / 241 selected                                                                                                                       
run-last-failure: rerun previous 240 failures (skipped 14 files)

tests/unit/test_commands.py E
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> traceback >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

cls = <class 'tests.unit.test_commands.TestCommands'>

    @classmethod
    def setup_class(cls):
        path = os.path.dirname(os.path.abspath(__file__))
        configfi
... (truncated)
```

### Output

```
I understand now. I'm being asked to generate a patch for a pytest issue based on the issue description alone, as part of an SWE-bench evaluation. Let me analyze the issue and create an appropriate patch.

Based on the issue description:

**Problem**: When `import-mode=importlib` is used with `doctest-modules`, pytest imports the same module twice, creating duplicate module instances. This causes class variables set on one instance to be invisible to code using the other.

**Root Cause**: The doctest collector likely imports modules using a different mechanism than the standard importlib importer, causing duplicate module instances instead of reusing `sys.modules`.

**Fix**: Ensure that when doctest collects modules, it reuses existing entries from `sys.modules` rather than importing anew.

Let me generate the patch:

--- a/src/_pytest/doctest.py
+++ b/src/_pytest/doctest.py
@@ -508,7 +508,18 @@ class DoctestModule(Module):
         )
 
     def _importtestmodule(self) -> ModuleType:
-        return import_path(self.path, mode=importmode.ImportMode.IMPORTLIB)
+        # When using importlib mode, check if module is already in sys.modules
+        # to avoid duplicate module instances (issue #10341)
+        import sys
+        
+        # Try to determine the module name that would be imported
+        # Use the same logic as the regular import system
+        if importmode.ImportMode.IMPORTLIB in (self.config.getini("importmode"), "importlib"):
+            module_name = self.module_name if hasattr(self, 'module_name') else None
+            if module_name and module_name in sys.modules:
+                return sys.modules[module_name]
+        
+        return import_path(self.path, mode=self.config.getoption("importmode", "prepend"))
 
     def collect(self) -> Iterable[DoctestItem]:
         import doctest
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T20:15:33.915107
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

