# Trajectory: sphinx-doc__sphinx-10451

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T20:46:16.025791

---

## Step 1: Architect

**Timestamp:** 2026-01-05T20:45:23.842299
**Duration:** 10.13s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: sphinx-doc/sphinx
ISSUE:
Fix duplicated *args and **kwargs with autodoc_typehints
Fix duplicated *args and **kwargs with autodoc_typehints

### Bugfix
- Bugfix

### Detail
Consider this
```python
class _ClassWithDocumentedInitAndStarArgs:
    """Class docstring."""

    def __init__(self, x: int, *args: int, **kwargs: int) -> None:
        """Init docstring.

        :param x: Some integer
        :param *args: Some integer
        :param **kwargs: Some integer
        """
```
when using the autodoc extension and the setting `autodoc_typehints = "description"`.

WIth sphinx 4.2.0, the current output is
```
Class docstring.

   Parameters:
      * **x** (*int*) --

      * **args** (*int*) --

      * **kwargs** (*int*) --

   Return type:
      None

   __init__(x, *args, **kwargs)

      Init docstring.

      Parameters:
         * **x** (*int*) -- Some integer

         * ***args** --

           Some integer

         * ****kwargs** --

           Some integer

         * **args** (*int*) --

         * **kwargs** (*int*) --

      Return type:
         None
```
where the *args and **kwargs are duplicated and incomplete.

The expected output is
```
  Class docstring.

   Parameters:
      * **x** (*int*) --

      * ***args** (*int*) --

      * ****kwargs** (*int*) --

   Return type:
      None

   __init__(x, *args, **kwargs)

      Init docstring.

      Parameters:
         * **x** (*int*) -- Some integer

         * ***args** (*int*) --

           Some integer

         * ****kwargs** (*int*) --

           Some integer

      Return type:
         None

```


HINTS:
I noticed this docstring causes warnings because `*` and `**` are considered as mark-up symbols:

```
    def __init__(self, x: int, *args: int, **kwargs: int) -> None:
        """Init docstring.

        :param x: Some integer
  
... (truncated)
```

### Output

```
## Issue Analysis

**Bug**: When using `autodoc_typehints = "description"`, `*args` and `**kwargs` parameters are duplicated in the documentation - they appear both with and without type hints, and the type hints are missing from the manually documented versions.

**Root Cause**: The autodoc type hints merging logic doesn't properly handle variadic arguments (`*args`, `**kwargs`). It's likely adding them as separate entries instead of merging with existing documented parameters.

**Files Affected**: 
- `sphinx/ext/autodoc/typehints.py` - handles merging type hints into parameter descriptions
- Possibly `sphinx/ext/autodoc/__init__.py` - parameter processing logic

**Fix Strategy**: When merging type hints for parameters, detect `*args` and `**kwargs` by their prefix and merge them with existing field list entries that already document these parameters (with or without the `*` prefix). Ensure the merged output preserves the correct number of asterisks for proper reST formatting.

**Edge Cases**: Parameters named `args`/`kwargs` without asterisks, escaped asterisks in docstrings, Google/Numpy docstring formats converted by Napoleon.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T20:46:16.025392
**Duration:** 52.18s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: sphinx-doc/sphinx
ISSUE:
Fix duplicated *args and **kwargs with autodoc_typehints
Fix duplicated *args and **kwargs with autodoc_typehints

### Bugfix
- Bugfix

### Detail
Consider this
```python
class _ClassWithDocumentedInitAndStarArgs:
    """Class docstring."""

    def __init__(self, x: int, *args: int, **kwargs: int) -> None:
        """Init docstring.

        :param x: Some integer
        :param *args: Some integer
        :param **kwargs: Some integer
        """
```
when using the autodoc extension and the setting `autodoc_typehints = "description"`.

WIth sphinx 4.2.0, the current output is
```
Class docstring.

   Parameters:
      * **x** (*int*) --

      * **args** (*int*) --

      * **kwargs** (*int*) --

   Return type:
      None

   __init__(x, *args, **kwargs)

      Init docstring.

      Parameters:
         * **x** (*int*) -- Some integer

         * ***args** --

           Some integer

         * ****kwargs** --

           Some integer

         * **args** (*int*) --

         * **kwargs** (*int*) --

      Return type:
         None
```
where the *args and **kwargs are duplicated and incomplete.

The expected output is
```
  Class docstring.

   Parameters:
      * **x** (*int*) --

      * ***args** (*int*) --

      * ****kwargs** (*int*) --

   Return type:
      None

   __init__(x, *args, **kwargs)

      Init docstring.

      Parameters:
         * **x** (*int*) -- Some integer

         * ***args** (*int*) --

           Some integer

         * ****kwargs** (*int*) --

           Some integer

      Return type:
         None

```


ARCHITECT'S ANALYSIS:
## Issue Analysis

**Bug**: When using `autodoc_typehints = "description"`, `*args` and `**kwargs` parameters are duplicated in the documentation - they appear both with and without type hints, and the type hin
... (truncated)
```

### Output

```
Based on my analysis of the Sphinx autodoc issue and the architect's analysis, I need to create a patch that fixes the duplication of `*args` and `**kwargs` when using `autodoc_typehints = "description"`. The issue is in the type hints merging logic in `sphinx/ext/autodoc/typehints.py`.

The problem is that when merging type hints into parameter descriptions, the code doesn't properly handle variadic arguments. It needs to:
1. Detect `*args` and `**kwargs` parameters 
2. Match them with existing field list entries (which may have the asterisk prefix in the docstring)
3. Merge the type information without creating duplicates
4. Preserve the correct number of asterisks for proper reST formatting

Here's the patch:

--- a/sphinx/ext/autodoc/typehints.py
+++ b/sphinx/ext/autodoc/typehints.py
@@ -44,6 +44,20 @@ def merge_typehints(app: Sphinx, domain: str, objtype: str, contentnode: Elemen
             if _name in annotations and _name not in arguments:
                 field = cast(nodes.field, field_list[i])
                 arguments[_name] = _annotation
+        
+        # Handle *args and **kwargs - match with or without asterisks
+        for field_list_item in field_list:
+            field_name = field_list_item[0].astext()
+            if field_name.startswith('**'):
+                # **kwargs case
+                clean_name = field_name.lstrip('*')
+                if clean_name in annotations and clean_name not in arguments:
+                    arguments[clean_name] = field_list_item
+            elif field_name.startswith('*'):
+                # *args case  
+                clean_name = field_name.lstrip('*')
+                if clean_name in annotations and clean_name not in arguments:
+                    arguments[clean_name] = field_list_item
     
     for field_list in field_lists:
         if app.config.autodoc_typehints_description_target == "all":
@@ -58,6 +72,14 @@ def merge_typehints(app: Sphinx, domain: str, objtype: str, contentnode: Elemen
                 elif _name in annotations:
                     field = cast(nodes.field, field_list[i])
                     _inject_types_to_field(field, annotations[_name])
+                
+                # Check if this is a *args or **kwargs field that needs type merging
+                if _name.startswith('*'):
+                    clean_name = _name.lstrip('*')
+                    if clean_name in annotations:
+                        field = cast(nodes.field, field_list[i])
+                        _inject_types_to_field(field, annotations[clean_name])
+                        annotations.pop(clean_name, None)  # Remove to prevent duplication
     
     for field_list in field_lists:
         for field in field_list:
@@ -80,6 +102,13 @@ def merge_typehints(app: Sphinx, domain: str, objtype: str, contentnode: Elemen
         for name, annotation in annotations.items():
             if name in arguments:
                 continue
+            
+            # Skip if this is args/kwargs and already documented with asterisks
+            if name in ('args', 'kwargs'):
+                if any(field[0].astext().lstrip('*') == name for field in field_list):
+                    continue
+            
+            # Create new field for undocumented parameters with type hints
             field = nodes.field()
             field += nodes.field_name('', name)
             field += nodes.field_body('', nodes.paragraph('', annotation))
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T20:46:16.025461
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

