# Trajectory: django__django-12308

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T18:25:41.229009

---

## Step 1: Architect

**Timestamp:** 2026-01-05T18:25:03.354908
**Duration:** 20.12s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
JSONField are not properly displayed in admin when they are readonly.
Description
	
JSONField values are displayed as dict when readonly in the admin.
For example, {"foo": "bar"} would be displayed as {'foo': 'bar'}, which is not valid JSON.
I believe the fix would be to add a special case in django.contrib.admin.utils.display_for_field to call the prepare_value of the JSONField (not calling json.dumps directly to take care of the InvalidJSONInput case).


HINTS:
â€‹PR
The proposed patch is problematic as the first version coupled contrib.postgres with .admin and the current one is based off the type name which is brittle and doesn't account for inheritance. It might be worth waiting for #12990 to land before proceeding here as the patch will be able to simply rely of django.db.models.JSONField instance checks from that point.

Your job:
1. Understand what the issue is about
2. Identify which file(s) likely need to be changed
3. Describe the fix approach (2-3 sentences)
4. Note any edge cases

Output a brief analysis (5-7 lines max) with:
- What the bug/issue is
- Files likely affected
- Fix strategy

Keep it concise - the Engineer agent will generate the patch.
```

### Output

```
Based on the issue description and hints provided, I can provide the analysis:

## Analysis

**What the bug is:**
JSONField values in Django admin are displayed using Python's dict representation (e.g., `{'foo': 'bar'}`) instead of valid JSON format (`{"foo": "bar"}`) when the field is readonly. This happens because the admin doesn't call the JSONField's `prepare_value()` method for display.

**Files likely affected:**
- `django/contrib/admin/utils.py` - The `display_for_field()` function needs modification to handle JSONField specially

**Fix strategy:**
Add a special case in `display_for_field()` to detect JSONField instances and call their `prepare_value()` method, which properly serializes to JSON format while handling edge cases like `InvalidJSONInput`. The hint suggests waiting for issue #12990 to land so the fix can use `django.db.models.JSONField` instance checks instead of brittle type name checking.

**Edge cases:**
- `InvalidJSONInput` case must be handled (already covered by `prepare_value()`)
- Should work with JSONField inheritance/subclasses (instance check handles this)
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T18:25:41.228849
**Duration:** 37.87s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
JSONField are not properly displayed in admin when they are readonly.
Description
	
JSONField values are displayed as dict when readonly in the admin.
For example, {"foo": "bar"} would be displayed as {'foo': 'bar'}, which is not valid JSON.
I believe the fix would be to add a special case in django.contrib.admin.utils.display_for_field to call the prepare_value of the JSONField (not calling json.dumps directly to take care of the InvalidJSONInput case).


ARCHITECT'S ANALYSIS:
Based on the issue description and hints provided, I can provide the analysis:

## Analysis

**What the bug is:**
JSONField values in Django admin are displayed using Python's dict representation (e.g., `{'foo': 'bar'}`) instead of valid JSON format (`{"foo": "bar"}`) when the field is readonly. This happens because the admin doesn't call the JSONField's `prepare_value()` method for display.

**Files likely affected:**
- `django/contrib/admin/utils.py` - The `display_for_field()` function needs modification to handle JSONField specially

**Fix strategy:**
Add a special case in `display_for_field()` to detect JSONField instances and call their `prepare_value()` method, which properly serializes to JSON format while handling edge cases like `InvalidJSONInput`. The hint suggests waiting for issue #12990 to land so the fix can use `django.db.models.JSONField` instance checks instead of brittle type name checking.

**Edge cases:**
- `InvalidJSONInput` case must be handled (already covered by `prepare_value()`)
- Should work with JSONField inheritance/subclasses (instance check handles this)

Generate a git patch (unified diff format) that fixes this issue.

IMPORTANT:
1. Output ONLY the patch in unified diff format
2. Include proper file paths with a/ and b/ prefixes
3. Include @@ line numbers
4. No explanations, no markdown code blocks, just raw patch

Example format:
--- a/path/to/file.py
+++ b/pa
... (truncated)
```

### Output

```
--- a/django/contrib/admin/utils.py
+++ b/django/contrib/admin/utils.py
@@ -1,4 +1,5 @@
 import datetime
+import json
 import decimal
 from collections import defaultdict
 
@@ -6,6 +7,7 @@ from django.core.exceptions import FieldDoesNotExist
 from django.db import models, router
 from django.db.models.constants import LOOKUP_SEP
 from django.db.models.deletion import Collector
+from django.db.models.fields.json import JSONField
 from django.forms.utils import pretty_name
 from django.urls import NoReverseMatch, reverse
 from django.utils import formats, timezone
@@ -396,6 +398,11 @@ def display_for_field(value, field, empty_value_display):
         return formats.number_format(value)
     elif isinstance(field, models.FileField) and value:
         return format_html('<a href="{}">{}</a>', value.url, value)
+    elif isinstance(field, JSONField):
+        if value is None:
+            return empty_value_display
+        # Use prepare_value to handle InvalidJSONInput edge case
+        return field.prepare_value(value)
     else:
         return display_for_value(value, empty_value_display)
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T18:25:41.228880
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

