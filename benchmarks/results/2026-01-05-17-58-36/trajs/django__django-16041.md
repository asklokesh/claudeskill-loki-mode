# Trajectory: django__django-16041

**Generated by:** Loki Mode Multi-Agent System
**Model:** sonnet
**Timestamp:** 2026-01-05T19:18:38.215750

---

## Step 1: Architect

**Timestamp:** 2026-01-05T19:18:11.173793
**Duration:** 8.92s

### Prompt

```
You are the ARCHITECT AGENT analyzing a GitHub issue.

REPOSITORY: django/django
ISSUE:
Rendering empty_form crashes when empty_permitted is passed to form_kwargs
Description
	
Issue
When explicitly setting form_kwargs = {'empty_permitted':True} or form_kwargs = {'empty_permitted':False} , a KeyError occurs when rendering a template that uses a formset's empty_form.
Expected Behavior
empty_permitted is ignored for formset.empty_form since empty_permitted is irrelevant for empty_form, as empty_form is not meant to be used to pass data and therefore does not need to be validated.
Steps to Reproduce
# views.py
from django.shortcuts import render
from .models import MyModel
def test_view(request):
	context = {}
	ff = modelformset_factory(MyModel, fields = ['a_field'])
	context['formset'] = ff(
		queryset = MyModel.objects.none(),
		form_kwargs = {'empty_permitted':True} # or form_kwargs = {'empty_permitted':False}
	)
	return render(request, 'my_app/my_model_formset.html', context)
# urls.py
from django.urls import path, include
from .views import test_view
urlpatterns = [
	path('test', test_view)
]
# my_model_formset.html
{% extends "my_app/base.html" %}
{% block content %}
<form id="my-form" method="post">
 {% csrf_token %}
 {{ formset }}
 <input type="submit" value="Save">
</form>
{{ formset.empty_form }}
{% endblock %}


HINTS:
Thanks for the report. It should be enough to change form_kwargs for empty_form, e.g. django/forms/formsets.py diff --git a/django/forms/formsets.py b/django/forms/formsets.py index 57676428ff..b73d1d742e 100644 a b class BaseFormSet(RenderableFormMixin): 257257 258258 @property 259259 def empty_form(self): 260 form = self.form( 261 auto_id=self.auto_id, 262 prefix=self.add_prefix("__prefix__"), 263 empty_permitted=True, 264 use_required_attribute=False, 260 form_kwargs = { 265261 **self.get_form_kwargs(None), 266 renderer=self.renderer, 267 ) 262 "auto_id": self.auto_id, 263 "prefix": self.add_prefix("__prefix__"), 264 "use_required_attribute
... (truncated)
```

### Output

```
## Analysis

**Bug**: When `form_kwargs` contains `empty_permitted`, rendering `formset.empty_form` crashes with "multiple values for keyword argument 'empty_permitted'" because the `empty_form` property explicitly passes `empty_permitted=True` while also unpacking `form_kwargs` which may already contain it.

**Files affected**: `django/forms/formsets.py` (specifically the `empty_form` property around line 260)

**Fix strategy**: Build the `form_kwargs` dictionary by first unpacking `self.get_form_kwargs(None)`, then explicitly set required keys (`auto_id`, `prefix`, `use_required_attribute`, `empty_permitted`, `renderer`) which will override any conflicting values from `get_form_kwargs()`. This ensures `empty_permitted=True` always wins for empty_form while avoiding duplicate keyword argument errors.

**Edge cases**: Any other kwargs in `get_form_kwargs()` that conflict with the explicit parameters should be handled similarly by merging into a single dict before passing to `self.form()`.
```

---

## Step 2: Engineer

**Timestamp:** 2026-01-05T19:18:38.215347
**Duration:** 27.04s

### Prompt

```
You are the ENGINEER AGENT generating a patch for a GitHub issue.

REPOSITORY: django/django
ISSUE:
Rendering empty_form crashes when empty_permitted is passed to form_kwargs
Description
	
Issue
When explicitly setting form_kwargs = {'empty_permitted':True} or form_kwargs = {'empty_permitted':False} , a KeyError occurs when rendering a template that uses a formset's empty_form.
Expected Behavior
empty_permitted is ignored for formset.empty_form since empty_permitted is irrelevant for empty_form, as empty_form is not meant to be used to pass data and therefore does not need to be validated.
Steps to Reproduce
# views.py
from django.shortcuts import render
from .models import MyModel
def test_view(request):
	context = {}
	ff = modelformset_factory(MyModel, fields = ['a_field'])
	context['formset'] = ff(
		queryset = MyModel.objects.none(),
		form_kwargs = {'empty_permitted':True} # or form_kwargs = {'empty_permitted':False}
	)
	return render(request, 'my_app/my_model_formset.html', context)
# urls.py
from django.urls import path, include
from .views import test_view
urlpatterns = [
	path('test', test_view)
]
# my_model_formset.html
{% extends "my_app/base.html" %}
{% block content %}
<form id="my-form" method="post">
 {% csrf_token %}
 {{ formset }}
 <input type="submit" value="Save">
</form>
{{ formset.empty_form }}
{% endblock %}


ARCHITECT'S ANALYSIS:
## Analysis

**Bug**: When `form_kwargs` contains `empty_permitted`, rendering `formset.empty_form` crashes with "multiple values for keyword argument 'empty_permitted'" because the `empty_form` property explicitly passes `empty_permitted=True` while also unpacking `form_kwargs` which may already contain it.

**Files affected**: `django/forms/formsets.py` (specifically the `empty_form` property around line 260)

**Fix strategy**: Build the `form_kwargs` dictionary by first unpacking `self.get_form_kwargs(None)`, then explicitly set required keys (`auto_id`, `prefix`, `use_required_attribute`, `empty_permitted`, `rend
... (truncated)
```

### Output

```
Based on the architect's analysis, I need to generate a patch for the Django formsets.py file. Since the repository is django/django and the file should be at django/forms/formsets.py, I'll create the patch based on the standard Django codebase structure and the architect's analysis.

The issue is in the `empty_form` property where `empty_permitted=True` is passed explicitly while `form_kwargs` may already contain it, causing a "multiple values for keyword argument" error.

The fix is to build the kwargs dictionary by first unpacking `get_form_kwargs(None)`, then explicitly setting the required keys to override any conflicts.

--- a/django/forms/formsets.py
+++ b/django/forms/formsets.py
@@ -257,12 +257,14 @@
     @property
     def empty_form(self):
         form = self.form(
-            auto_id=self.auto_id,
-            prefix=self.add_prefix("__prefix__"),
-            empty_permitted=True,
-            use_required_attribute=False,
-            **self.get_form_kwargs(None),
-            renderer=self.renderer,
+            **{
+                **self.get_form_kwargs(None),
+                "auto_id": self.auto_id,
+                "prefix": self.add_prefix("__prefix__"),
+                "empty_permitted": True,
+                "use_required_attribute": False,
+                "renderer": self.renderer,
+            }
         )
         self.add_fields(form, None)
         return form
```

---

## Step 3: QA

**Timestamp:** 2026-01-05T19:18:38.215416
**Duration:** 0.0s

### Output

```
Valid: True, Error: None
```

### Validation Checks

- diff_headers: PASS
- hunk_headers: PASS
- has_changes: PASS
- no_markdown_wrap: PASS
- path_prefixes: PASS

---

