{
  "instance_id": "django__django-11039",
  "model_name_or_path": "loki-mode-sonnet",
  "model_patch": "Based on the issue description and architect's analysis, I can generate the patch directly. The issue is clear: the `sqlmigrate` command needs to check both `migration.atomic` and `connection.features.can_rollback_ddl` when setting `self.output_transaction`, just like the migration executor does.\n\n--- a/django/core/management/commands/sqlmigrate.py\n+++ b/django/core/management/commands/sqlmigrate.py\n@@ -59,7 +59,7 @@ class Command(BaseCommand):\n         plan = [(executor.loader.graph.nodes[targets[0]], options['backwards'])]\n         sql_statements = executor.collect_sql(plan)\n         if not sql_statements and options['verbosity'] >= 1:\n             self.stderr.write('No operations found.')\n         return '\\n'.join(sql_statements)\n \n-        self.output_transaction = migration.atomic\n+        self.output_transaction = migration.atomic and connection.features.can_rollback_ddl\n--- a/tests/migrations/test_commands.py\n+++ b/tests/migrations/test_commands.py\n@@ -1234,6 +1234,23 @@ class MigrateTests(MigrationTestBase):\n         out = io.StringIO()\n         call_command(\"sqlmigrate\", \"migrations\", \"0001\", stdout=out)\n         self.assertNotIn(\"BEGIN;\", out.getvalue())\n         self.assertNotIn(\"COMMIT;\", out.getvalue())\n \n+    def test_sqlmigrate_no_transaction_for_non_transactional_ddl(self):\n+        \"\"\"\n+        sqlmigrate shouldn't wrap output in BEGIN/COMMIT if the database\n+        doesn't support transactional DDL.\n+        \"\"\"\n+        out = io.StringIO()\n+        with mock.patch.object(\n+            connection.features, 'can_rollback_ddl', False\n+        ):\n+            call_command(\n+                \"sqlmigrate\", \"migrations\", \"0001\", stdout=out\n+            )\n+        output = out.getvalue()\n+        self.assertNotIn(\"BEGIN;\", output)\n+        self.assertNotIn(\"COMMIT;\", output)\n+\n     @override_settings(MIGRATION_MODULES={'migrations': 'migrations.test_migrations'})\n     def test_regression_22823_unmigrated_fk_to_migrated_model(self):\n         \"\"\"",
  "attempts": 1,
  "success": true,
  "error": null,
  "timestamp": "2026-01-05T18:07:43.359698"
}