{
  "instance_id": "matplotlib__matplotlib-23476",
  "model_name_or_path": "loki-mode-sonnet",
  "model_patch": "I understand now. I'm being asked to generate a patch for a matplotlib bug as an ENGINEER AGENT, but I'm in a Loki Mode repository. The task is to create the patch content directly based on the issue description and the architect's analysis. Let me create the patch:\n\n--- a/lib/matplotlib/backends/backend_macosx.py\n+++ b/lib/matplotlib/backends/backend_macosx.py\n@@ -28,7 +28,12 @@ class FigureCanvasMac(FigureCanvasBase):\n     def __init__(self, figure):\n         super().__init__(figure)\n         width, height = self.get_width_height()\n-        _macosx.FigureCanvas.__init__(self, width, height)\n+        # Divide by device pixel ratio to get logical pixels\n+        # On M1 Macs, the device pixel ratio is 2.0, which causes\n+        # DPI doubling during pickle/unpickle cycles\n+        dpi_ratio = figure.dpi / figure._original_dpi if hasattr(figure, '_original_dpi') else 1.0\n+        logical_width = int(width / dpi_ratio) if dpi_ratio > 1.0 else width\n+        logical_height = int(height / dpi_ratio) if dpi_ratio > 1.0 else height\n+        _macosx.FigureCanvas.__init__(self, logical_width, logical_height)\n         self._dpi_ratio = 2 if self.device_pixel_ratio >= 2 else 1\n \n \n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -2882,6 +2882,9 @@ class Figure(FigureBase):\n         \"\"\"\n         state = super().__getstate__()\n         \n+        # Store original DPI to prevent doubling on unpickle\n+        state['_original_dpi'] = self._original_dpi if hasattr(self, '_original_dpi') else self.dpi\n+        \n         # The canvas cannot currently be pickled, but this has the benefit\n         # of meaning that a figure can be detached from one canvas, and\n         # re-attached to another.\n@@ -2905,6 +2908,13 @@ class Figure(FigureBase):\n         state.pop('canvas')\n         self.__dict__ = state\n \n+        # Restore original DPI to prevent doubling on M1 Macs\n+        # The MacOSX backend applies a device pixel ratio that doubles DPI\n+        if '_original_dpi' in state:\n+            self._original_dpi = state['_original_dpi']\n+            if self.dpi != self._original_dpi:\n+                self.dpi = self._original_dpi\n+\n         # re-initialise some of the unstored state information\n         FigureCanvasBase(self)  # Set self.canvas.\n \n@@ -3141,6 +3151,7 @@ class Figure(FigureBase):\n         else:\n             self.dpi_scale_trans = Affine2D().scale(dpi)\n         self._dpi = dpi\n+        self._original_dpi = dpi\n         self.stale = True\n \n     @property",
  "attempts": 1,
  "success": true,
  "error": null,
  "timestamp": "2026-01-05T19:32:44.299079"
}