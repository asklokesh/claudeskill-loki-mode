{
  "instance_id": "django__django-15814",
  "model_name_or_path": "loki-mode-sonnet",
  "model_patch": "Based on the issue description, I need to generate a patch that fixes the `deferred_to_columns` method in `django/db/models/sql/query.py`. The fix involves using the concrete model's metadata instead of the proxy model's metadata.\n\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -742,7 +742,8 @@\n                 model = field.model._meta.concrete_model\n             fields.append(field)\n \n-        opts = cur_model._meta\n+        cur_model = cur_model._meta.concrete_model\n+        opts = cur_model._meta\n         if only_load:\n             # In the case of only(), only add fields to the deferred set if\n             # they are not being loaded. Fields specified by only() will\n--- a/tests/proxy_models/tests.py\n+++ b/tests/proxy_models/tests.py\n@@ -1,6 +1,7 @@\n from django.contrib.contenttypes.models import ContentType\n from django.core import management\n from django.db import DEFAULT_DB_ALIAS\n+from django.db.models import ForeignKey, SET_NULL\n from django.test import TestCase, TransactionTestCase, override_settings\n \n from .models import (\n@@ -537,3 +538,22 @@\n         self.assertEqual(MyPerson.objects.count(), 1)\n         self.assertEqual(StatusPerson.objects.count(), 1)\n         self.assertFalse(MyPerson.objects.exists())\n+\n+    def test_select_related_only_with_proxy(self):\n+        \"\"\"\n+        Test that select_related() and only() work correctly with proxy models.\n+        Regression test for issue where QuerySet.only() after select_related()\n+        would crash on proxy models with ValueError: 'id' is not in list.\n+        \"\"\"\n+        from .models import Country, State\n+        \n+        # Create test data\n+        country = Country.objects.create(name=\"Test Country\")\n+        State.objects.create(name=\"Test State\", country=country)\n+        \n+        # This should not raise ValueError\n+        states = list(\n+            State.objects.select_related(\"country\").only(\"country__name\").all()\n+        )\n+        \n+        self.assertEqual(len(states), 1)",
  "attempts": 1,
  "success": true,
  "error": null,
  "timestamp": "2026-01-05T19:13:10.750760"
}